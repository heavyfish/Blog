<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/heavyfish.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/heavyfish.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/heavyfish.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/heavyfish.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="/heavyfish.github.io/css/main.css">

</script>


<link rel="stylesheet" href="/heavyfish.github.io/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"heavyfish.github.io","root":"/heavyfish.github.io/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="主要是从此文 手动搭建Kubernetes-v1.16.8高可用集群（完结）进行了学习摘抄，用二进制文件方式手动搭建Kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="手动搭建Kubernetes">
<meta property="og:url" content="https://heavyfish.github.io/2020/11/09/k8s/%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAKubernetes/index.html">
<meta property="og:site_name" content="请问你能包养我吗">
<meta property="og:description" content="主要是从此文 手动搭建Kubernetes-v1.16.8高可用集群（完结）进行了学习摘抄，用二进制文件方式手动搭建Kubernetes">
<meta property="og:locale">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223500350.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223529225.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223535568.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223542034.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223548228.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223602205.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223615014.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223626361.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223634689.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223640108.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223651605.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223656926.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223704848.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223710782.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223718385.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223725868.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223730344.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223735935.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223741291.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223746506.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223752844.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223758350.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223807089.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223813082.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223818702.png">
<meta property="og:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223823825.png">
<meta property="article:published_time" content="2020-11-09T06:25:14.334Z">
<meta property="article:modified_time" content="2021-01-17T14:53:36.106Z">
<meta property="article:author" content="Shenxr">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223500350.png">

<link rel="canonical" href="https://heavyfish.github.io/2020/11/09/k8s/%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAKubernetes/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>手动搭建Kubernetes | 请问你能包养我吗</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/heavyfish.github.io/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">请问你能包养我吗</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/heavyfish.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/heavyfish.github.io/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://heavyfish.github.io/2020/11/09/k8s/%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BAKubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/heavyfish.github.io/images/avatar.gif">
      <meta itemprop="name" content="Shenxr">
      <meta itemprop="description" content="在被人包养前，记录学习笔记的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="请问你能包养我吗">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          手动搭建Kubernetes
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-09 14:25:14" itemprop="dateCreated datePublished" datetime="2020-11-09T14:25:14+08:00">2020-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-17 22:53:36" itemprop="dateModified" datetime="2021-01-17T22:53:36+08:00">2021-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/heavyfish.github.io/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>70k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1:03</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>主要是从此文 <a target="_blank" rel="noopener" href="https://blog.z0ukun.com/?p=2391">手动搭建Kubernetes-v1.16.8高可用集群（完结）</a>进行了学习摘抄，用二进制文件方式手动搭建Kubernetes</p>
<a id="more"></a>

<h1 id="参考文件"><a href="#参考文件" class="headerlink" title="参考文件"></a>参考文件</h1><p><a target="_blank" rel="noopener" href="https://blog.z0ukun.com/?p=2391">手动搭建Kubernetes-v1.16.8高可用集群（完结）</a>（基于此文档编辑修改）</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/">kube-apiserver config</a>官网中文</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/">kube-apiserver config</a>官网英文</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubectl/kubectl/">kubectl config 官网中文</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-controller-manager/">kube-controller-manager</a>官网中文</p>
<h1 id="1、组件版本说明（参考）"><a href="#1、组件版本说明（参考）" class="headerlink" title="1、组件版本说明（参考）"></a>1、组件版本说明（参考）</h1><table>
<thead>
<tr>
<th><strong>序号</strong></th>
<th><strong>组件</strong></th>
<th><strong>版本</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>kubernetes</td>
<td>v1.16.8</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>etcd</td>
<td>v3.3.20</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>docker</td>
<td>v18.09.6</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>flannel</td>
<td>v0.11.0</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>coredns</td>
<td>v1.6.7</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>dashboard</td>
<td>v2.0.0-rc4</td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>k8s-prometheus-adapter</td>
<td>v0.5.0</td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>prometheus-operator</td>
<td>v0.38.0</td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>prometheus</td>
<td>v2.15.2</td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>elasticsearch、kibana</td>
<td>v7.2.0</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>cni-plugins</td>
<td>v0.8.5</td>
<td></td>
</tr>
<tr>
<td>12</td>
<td>metrics-server</td>
<td>v0.3.6</td>
<td></td>
</tr>
<tr>
<td>13</td>
<td>weave</td>
<td>v1.13.0</td>
<td></td>
</tr>
<tr>
<td>14</td>
<td>kubeapps</td>
<td>v1.8.2</td>
<td></td>
</tr>
<tr>
<td>15</td>
<td>helm</td>
<td>v3.1.0</td>
<td></td>
</tr>
<tr>
<td>16</td>
<td>grafana</td>
<td>v1.13.0</td>
<td></td>
</tr>
<tr>
<td>17</td>
<td>traefik</td>
<td>v2.1</td>
<td></td>
</tr>
</tbody></table>
<p><strong>主要配置策略</strong></p>
<p>kube-apiserver：</p>
<ul>
<li>使用节点本地 nginx 4 层透明代理实现高可用；</li>
<li>关闭非安全端口 8080 和匿名访问；</li>
<li>在安全端口 6443 接收 https 请求；</li>
<li>严格的认证和授权策略 (x509、token、RBAC)；</li>
<li>开启 bootstrap token 认证，支持 kubelet TLS bootstrapping；</li>
<li>使用 https 访问 kubelet、etcd，加密通信；</li>
</ul>
<p>kube-controller-manager：</p>
<ul>
<li>3 节点高可用；</li>
<li>关闭非安全端口，在安全端口 10252 接收 https 请求；</li>
<li>使用 kubeconfig 访问 apiserver 的安全端口；</li>
<li>自动 approve kubelet 证书签名请求 (CSR)，证书过期后自动轮转；</li>
<li>各 controller 使用自己的 ServiceAccount 访问 apiserver；</li>
</ul>
<p>kube-scheduler：</p>
<ul>
<li>3 节点高可用；</li>
<li>使用 kubeconfig 访问 apiserver 的安全端口；</li>
</ul>
<p>kubelet：</p>
<ul>
<li>使用 kubeadm 动态创建 bootstrap token，而不是在 apiserver 中静态配置；</li>
<li>使用 TLS bootstrap 机制自动生成 client 和 server 证书，过期后自动轮转；</li>
<li>在 KubeletConfiguration 类型的 JSON 文件配置主要参数；</li>
<li>关闭只读端口，在安全端口 10250 接收 https 请求，对请求进行认证和授权，拒绝匿名访问和非授权访问；</li>
<li>使用 kubeconfig 访问 apiserver 的安全端口；</li>
</ul>
<p>kube-proxy：</p>
<ul>
<li>使用 kubeconfig 访问 apiserver 的安全端口；</li>
<li>在 KubeProxyConfiguration 类型的 JSON 文件配置主要参数；</li>
<li>使用 ipvs 代理模式；</li>
</ul>
<p>集群插件：</p>
<ul>
<li>DNS：使用功能、性能更好的 coredns；</li>
<li>Dashboard：支持登录认证；</li>
<li>Metric：metrics-server，使用 https 访问 kubelet 安全端口；</li>
<li>Log：Elasticsearch、Fluend、Kibana；</li>
<li>Registry 镜像库：docker-registry、harbor；</li>
</ul>
<h1 id="2、系统初始化"><a href="#2、系统初始化" class="headerlink" title="2、系统初始化"></a>2、系统初始化</h1><p><strong>集群规划</strong></p>
<ul>
<li>NFS Server：   172.16.200.10</li>
<li>Kubernetes-01：172.16.200.11</li>
<li>Kubernetes-02：172.16.200.12</li>
<li>Kubernetes-03：172.16.200.13</li>
</ul>
<p>这里我们准备4台主机，NFS Server作为NFS后端存储、部署NFS服务提供存储能力。另外三台机器混合部署etcd、master集群和woker集群。</p>
<p>注：如果没有特殊说明，本小节所有操作需要在所有节点上执行本文档的初始化操作。</p>
<p><strong>配置主机名</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 可以将下面的节点名称替换为自己的主机名称</span><br><span class="line">hostnamectl set-hostname NFS Server</span><br><span class="line">hostnamectl set-hostname Kubernetes-01</span><br><span class="line">hostnamectl set-hostname Kubernetes-02</span><br><span class="line">hostnamectl set-hostname Kubernetes-03</span><br></pre></td></tr></table></figure>


<p>如果 DNS 不支持主机名称解析，还需要在每台机器的 /etc/hosts 文件中添加主机名和 IP 的对应关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; &#x2F;etc&#x2F;hosts &lt;&lt;EOF</span><br><span class="line">172.16.200.10  NFS Server</span><br><span class="line">172.16.200.11  Kubernetes-01</span><br><span class="line">172.16.200.12  Kubernetes-02</span><br><span class="line">172.16.200.13  Kubernetes-03 </span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>


<p><strong>添加节点SSH互信</strong></p>
<p>本操作只需要在 Kubernetes-01 节点上进行，设置 root 账户可以无密码登录所有节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa </span><br><span class="line">ssh-copy-id root@Kubernetes-01</span><br><span class="line">ssh-copy-id root@Kubernetes-02</span><br><span class="line">ssh-copy-id root@Kubernetes-03</span><br><span class="line">ssh-copy-id root@NFS Server</span><br></pre></td></tr></table></figure>
<p><strong>更新PATH变量</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#39;PATH&#x3D;&#x2F;opt&#x2F;k8s&#x2F;bin:$PATH&#39; &gt;&gt;&#x2F;root&#x2F;.bashrc</span><br><span class="line">source &#x2F;root&#x2F;.bashrc</span><br></pre></td></tr></table></figure>
<p>注：/opt/k8s/bin 目录保存本文档下载安装的程序。</p>
<p><strong>安装依赖包</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release</span><br><span class="line">yum install -y chrony conntrack ipvsadm ipset jq iptables curl sysstat libseccomp wget socat git</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">conntrack:操作netfilter连接跟踪表并保持高可用</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ipvsadm：管理Linux Virtual Server 的工具</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ipset：Manage Linux IP sets</span></span><br><span class="line"><span class="meta">#</span><span class="bash">jq：Command-line JSON processor</span></span><br><span class="line"><span class="meta">#</span><span class="bash">sysstat：Linux性能监视工具的集合</span></span><br><span class="line"><span class="meta">#</span><span class="bash">libseccomp：增强的 seccomp 库,而Secure Computing Mode (seccomp) 是一种内核特性，它允许您从容器中过滤对内核的系统调用</span></span><br><span class="line"><span class="meta">#</span><span class="bash">socat：Socat 是 Linux 下的一个多功能的网络工具,可以看做是 Netcat 的加强版。</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_atomic_host/7/html/container_security_guide/linux_capabilities_and_seccomp">LINUX CAPABILITIES AND SECCOMP</a></p>
<p><a target="_blank" rel="noopener" href="https://www.hi-linux.com/posts/61543.html">Socat 入门教程</a></p>
<p>注：本文档的 kube-proxy 使用 ipvs 模式，ipvsadm 为 ipvs 的管理工具； etcd 集群各机器需要时间同步，chrony 用于系统时间同步。</p>
<p><strong>关闭防火墙</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">-F:刷新选中的链(如果没有给定链，则刷新表中的所有链)。这相当于逐一删除所有规则</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-X:删除指定的可选用户定义链。必须没有对链的引用。如果存在引用规则，则必须在删除链之前删除或替换引用规则。链必须是空的，即不包含任何规则。如果没有给出参数，它将尝试删除表中的所有非内建链</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-t:此选项指定命令应该操作的数据包匹配表</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-P:将链的策略设置为给定的规则。只有内置(非用户定义)链可以拥有策略，而且内置链和用户定义链都不能是策略目标</span></span><br></pre></td></tr></table></figure>
<p>注：关闭防火墙，清理防火墙规则，设置默认转发策略。</p>
<p> <strong>关闭swap分区</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">sed -i &#39;&#x2F; swap &#x2F; s&#x2F;^\(.*\)$&#x2F;#\1&#x2F;g&#39; &#x2F;etc&#x2F;fstab</span><br></pre></td></tr></table></figure>
<p>注：关闭 swap 分区，否则kubelet 会启动失败(可以设置 kubelet 启动参数 –fail-swap-on 为 false 关闭 swap 检查)。</p>
<p><strong>关闭SELinux</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -i &#39;s&#x2F;^SELINUX&#x3D;.*&#x2F;SELINUX&#x3D;disabled&#x2F;&#39; &#x2F;etc&#x2F;selinux&#x2F;config</span><br></pre></td></tr></table></figure>
<p>注：关闭 SELinux，否则 kubelet 挂载目录时可能报错 Permission denied。</p>
<p><strong>优化内核参数</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubernetes.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> 1 表示 二层的网桥在转发包时也会被iptables的FORWARD规则所过滤</span></span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 1 表示 开启Linux系统的路由转发功能</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭</span></span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 增加内核内部的ARP缓存大小</span></span><br><span class="line">net.ipv4.neigh.default.gc_thresh1=1024</span><br><span class="line">net.ipv4.neigh.default.gc_thresh2=2048</span><br><span class="line">net.ipv4.neigh.default.gc_thresh3=4096</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 不使用SWAP分区</span></span><br><span class="line">vm.swappiness=0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1 表示 内核允许分配所有的物理内存，而不管当前的内存状态如何</span></span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 0：内存不足时，启动 OOM killer</span></span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 表示每一个real user ID可创建的inotify instatnces的数量上限，默认128</span></span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line"><span class="meta">#</span><span class="bash"> 表示同一用户同时可以添加的watch数目（watch一般是针对目录，决定了同时同一用户可以监控的目录数量）</span></span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置Linux内核将分配的最大文件句柄数量。通常可设置为 total_Mem(M)/4 * 256</span></span><br><span class="line">fs.file-max=52706963</span><br><span class="line"><span class="meta">#</span><span class="bash"> nr_open是单个进程可分配的最大文件数</span></span><br><span class="line">fs.nr_open=52706963</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用ipv6</span></span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大跟踪连接数</span></span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">EOF</span><br><span class="line">cp kubernetes.conf  /etc/sysctl.d/kubernetes.conf</span><br><span class="line">sysctl -p /etc/sysctl.d/kubernetes.conf</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/94413312">关于gc_thresh可能出现的问题</a></p>
<p>inotify API提供了一种监视文件系统事件的机制。Inotify可以用于监视单个文件，也可以用于监视目录。当一个目录被监视时，inotify将返回目录本身和目录内文件的事件。<code>yum install inotify-tools</code> ，安装inotify的工具。</p>
<p>注：关闭 tcp_tw_recycle，否则与 NAT 冲突，可能导致服务不通。</p>
<p><strong>配置系统时区</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl set-timezone Asia&#x2F;Shanghai</span><br></pre></td></tr></table></figure>


<p><strong>配置时钟同步</strong></p>
<p>查看同步状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl status</span><br></pre></td></tr></table></figure>
<p>如果正确、输出信息如下（这里配的时候忘记截图了、后面补的截图）：</p>
<p>注：System clock synchronized: yes，表示时钟已同步； NTP service: active，表示开启了时钟同步服务。</p>
<p><strong>写入硬件时钟</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 将当前的 UTC 时间写入硬件时钟</span></span><br><span class="line">timedatectl set-local-rtc 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启依赖于系统时间的服务</span></span><br><span class="line">systemctl restart rsyslog </span><br><span class="line">systemctl restart crond</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">rsyslog：centos7的默认日志系统，用于在ip网络中转发日志信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash">crond：定时任务的守护进程</span></span><br></pre></td></tr></table></figure>


<p><strong>关闭无关服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop postfix &amp;&amp; systemctl disable postfix</span><br></pre></td></tr></table></figure>


<p><strong>创建配置目录</strong></p>
<p>创建接下来要使用的相关安装目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;opt&#x2F;k8s&#x2F;&#123;bin,work&#125; &#x2F;etc&#x2F;&#123;kubernetes,etcd&#125;&#x2F;cert</span><br></pre></td></tr></table></figure>


<p><strong>分发集群配置参数</strong></p>
<p>后续使用的环境变量都定义在文件 environment.sh 中，请根据自己的机器、网络情况修改：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成 EncryptionConfig 所需的加密 key</span></span><br><span class="line">export ENCRYPTION_KEY=$(head -c 32 /dev/urandom | base64)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 集群各机器 IP 数组</span></span><br><span class="line">export NODE_IPS=(172.16.200.11 172.16.200.12 172.16.200.13)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 集群各 IP 对应的主机名数组</span></span><br><span class="line">export NODE_NAMES=(Kubernetes-01 Kubernetes-02 Kubernetes-03)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> etcd 集群服务地址列表</span></span><br><span class="line">export ETCD_ENDPOINTS=&quot;https://172.16.200.11:2379,https://172.16.200.12:2379,https://172.16.200.13:2379&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> etcd 集群间通信的 IP 和端口</span></span><br><span class="line">export ETCD_NODES=&quot;Kubernetes-01=https://172.16.200.11:2380,Kubernetes-02=https://172.16.200.12:2380,Kubernetes-03=https://172.16.200.13:2380&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> kube-apiserver 的反向代理(kube-nginx)地址端口</span></span><br><span class="line">export KUBE_APISERVER=&quot;https://127.0.0.1:8443&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 节点间互联网络接口名称</span></span><br><span class="line">export IFACE=&quot;ens160&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> etcd 数据目录</span></span><br><span class="line">export ETCD_DATA_DIR=&quot;/data/k8s/etcd/data&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> etcd WAL 目录，建议是 SSD 磁盘分区，或者和 ETCD_DATA_DIR 不同的磁盘分区</span></span><br><span class="line">export ETCD_WAL_DIR=&quot;/data/k8s/etcd/wal&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> k8s 各组件数据目录</span></span><br><span class="line">export K8S_DIR=&quot;/data/k8s/k8s&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># DOCKER_DIR 和 CONTAINERD_DIR 二选一</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> docker 数据目录</span></span><br><span class="line">export DOCKER_DIR=&quot;/data/k8s/docker&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> containerd 数据目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">export</span> CONTAINERD_DIR=<span class="string">&quot;/data/k8s/containerd&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 以下参数一般不需要修改</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TLS Bootstrapping 使用的 Token，可以使用命令</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> head -c 16 /dev/urandom | od -An -t x | tr -d <span class="string">&#x27; &#x27;</span> 生成</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> od：以八进制和其他格式转储文件，-A:输出格式偏移，n表示None，-t：输出格式，x表示16进制</span></span><br><span class="line"></span><br><span class="line">BOOTSTRAP_TOKEN=&quot;41f7e4ba8b7be874fcff18bf5cf41a7c&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最好使用 当前未用的网段 来定义服务网段和 Pod 网段</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务网段，部署前路由不可达，部署后集群内路由可达(kube-proxy 保证)</span></span><br><span class="line">SERVICE_CIDR=&quot;10.254.0.0/16&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Pod 网段，建议 /16 段地址，部署前路由不可达，部署后集群内路由可达(flanneld 保证)</span></span><br><span class="line">CLUSTER_CIDR=&quot;172.30.0.0/16&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置flanneld的FLANNEL_ETCD_PREFIX文件目录</span></span><br><span class="line">export FLANNEL_ETCD_PREFIX=&quot;/kubernetes/network&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务端口范围 (NodePort Range)</span></span><br><span class="line">export NODE_PORT_RANGE=&quot;30000-32767&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> kubernetes 服务 IP (一般是 SERVICE_CIDR 中第一个IP)</span></span><br><span class="line">export CLUSTER_KUBERNETES_SVC_IP=&quot;10.254.0.1&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 集群 DNS 服务 IP (从 SERVICE_CIDR 中预分配)</span></span><br><span class="line">export CLUSTER_DNS_SVC_IP=&quot;10.254.0.2&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 集群 DNS 域名（末尾不带点号）</span></span><br><span class="line">export CLUSTER_DNS_DOMAIN=&quot;cluster.local&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将二进制目录 /opt/k8s/bin 加到 PATH 中</span></span><br><span class="line">export PATH=/opt/k8s/bin:$PATH</span><br></pre></td></tr></table></figure>
<p>注：因为我采用了flannel网络、所以这里我在原文的基础之上添加了export FLANNEL_ETCD_PREFIX=”/kubernetes/network”变量、禁止了containerd 数据目录。</p>
<p>把上面的 environment.sh 文件修改完成之后保存到 /opt/k8s/bin/ 目录下面，然后拷贝到所有节点（修改完上面的文件之后再执行下面的操作）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp environment.sh root@$&#123;node_ip&#125;:&#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;chmod +x &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;*&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223500350.png" alt="image-20210114223500350"></p>
<p><strong>内核升级</strong></p>
<p>CentOS 7.x 系统自带的 3.10.x 内核存在一些 Bugs，导致运行的 Docker、Kubernetes 不稳定，例如：</p>
<ul>
<li>高版本的 docker(1.13 以后) 启用了 3.10 kernel 实验支持的 kernel memory account 功能(无法关闭)，当节点压力大如频繁启动和停止容器时会导致 cgroup memory leak；</li>
<li>网络设备引用计数泄漏，会导致类似于报错：”kernel:unregister_netdevice: waiting for eth0 to become free. Usage count = 1”;</li>
</ul>
<p>解决方案如下：</p>
<ul>
<li>升级内核到 4.4.X 以上；</li>
<li>或者，手动编译内核，disable CONFIG_MEMCG_KMEM 特性；</li>
<li>或者，安装修复了该问题的 Docker 18.09.1 及以上的版本。但由于 kubelet 也会设置 kmem（它 vendor 了 runc），所以需要重新编译 kubelet 并指定 GOFLAGS=”-tags=nokmem”；</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone --branch v1.14.1 --single-branch --depth 1 https://github.com/kubernetes/kubernetes</span><br><span class="line">cd kubernetes</span><br><span class="line">KUBE_GIT_VERSION=v1.14.1 ./build/run.sh make kubelet GOFLAGS=&quot;-tags=nokmem&quot;</span><br></pre></td></tr></table></figure>


<p>这里采用升级内核的解决办法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装完成后检查 /boot/grub2/grub.cfg 中对应内核 menuentry 中是否包含 initrd16 配置，如果没有，再安装一次！</span></span><br><span class="line">yum --enablerepo=elrepo-kernel install -y kernel-lt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置开机从新内核启动</span></span><br><span class="line">grub2-set-default 0</span><br></pre></td></tr></table></figure>


<p>执行完上面所有的操作之后我们就可以重启所有主机了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sync</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>


<p>本小节参考文档：</p>
<ul>
<li>系统内核相关参数参考：<a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://docs.openshift.com/enterprise/3.2/admin_guide/overcommit.html">https://docs.openshift.com/enterprise/3.2/admin_guide/overcommit.html</a></li>
<li>3.10.x 内核 kmem bugs 相关的讨论和解决办法：<ul>
<li><a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://github.com/kubernetes/kubernetes/issues/61937">https://github.com/kubernetes/kubernetes/issues/61937</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://support.mesosphere.com/s/article/Critical-Issue-KMEM-MSPH-2018-0006">https://support.mesosphere.com/s/article/Critical-Issue-KMEM-MSPH-2018-0006</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://pingcap.com/blog/try-to-fix-two-linux-kernel-bugs-while-testing-tidb-operator-in-k8s/">https://pingcap.com/blog/try-to-fix-two-linux-kernel-bugs-while-testing-tidb-operator-in-k8s/</a></li>
</ul>
</li>
</ul>
<h1 id="3、创建CA证书和秘钥"><a href="#3、创建CA证书和秘钥" class="headerlink" title="3、创建CA证书和秘钥"></a>3、创建CA证书和秘钥</h1><p>为确保安全，kubernetes 系统各组件需要使用 x509 证书对通信进行加密和认证。 CA (Certificate Authority) 是自签名的根证书，用来签名后续创建的其它证书。 CA 证书是集群所有节点共享的，只需要创建一次，后续用它签名其它所有证书。 本小节使用 CloudFlare 的 PKI 工具集 cfssl 创建所有证书。</p>
<p>注：如果没有特殊指明，本小节所有操作均在 <strong>Kubernetes-01</strong> 节点上执行。</p>
<p><strong>安装 cfssl 工具集</strong></p>
<p>cfssl github项目地址：<a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://github.com/cloudflare/cfssl">https://github.com/cloudflare/cfssl</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /opt/k8s/cert &amp;&amp; cd /opt/k8s/work</span><br><span class="line"></span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssl_1.4.1_linux_amd64</span><br><span class="line">mv cfssl_1.4.1_linux_amd64 /opt/k8s/bin/cfssl</span><br><span class="line"></span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssljson_1.4.1_linux_amd64</span><br><span class="line">mv cfssljson_1.4.1_linux_amd64 /opt/k8s/bin/cfssljson</span><br><span class="line"></span><br><span class="line">wget https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssl-certinfo_1.4.1_linux_amd64</span><br><span class="line">mv cfssl-certinfo_1.4.1_linux_amd64 /opt/k8s/bin/cfssl-certinfo</span><br><span class="line"></span><br><span class="line">chmod +x /opt/k8s/bin/*</span><br><span class="line">export PATH=/opt/k8s/bin:$PAT</span><br><span class="line">echo &quot;alias cfssl=&#x27;cfssl_linux-amd64&#x27;&quot; &gt;&gt; ~/.bashrc</span><br><span class="line">echo &quot;alias cfssljson=&#x27;cfssljson_linux-amd64&#x27;&quot; &gt;&gt; ~/.bashrc</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><strong>创建配置文件</strong></p>
<p>CA 配置文件用于配置根证书的使用场景 (profile) 和具体参数 (usage，过期时间、服务端认证、客户端认证、加密等)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>signing：表示该证书可用于签名其它证书（生成的 ca.pem 证书中 CA=TRUE）；</li>
<li>server auth：表示 client 可以用该该证书对 server 提供的证书进行验证；</li>
<li>client auth：表示 server 可以用该该证书对 client 提供的证书进行验证；</li>
<li>“expiry”: “876000h”：证书有效期设置为 100 年；</li>
</ul>
<p><strong>创建证书签名请求文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cat &gt; ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes-ca&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;z0ukun&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;ca&quot;: &#123;</span><br><span class="line">    &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li><p>CN：Common Name：kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)，浏览器使用该字段验证网站是否合法；</p>
</li>
<li><p>O：Organization：kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</p>
</li>
<li><p>kube-apiserver 将提取的 User、Group 作为 RBAC 授权的用户标识；</p>
</li>
<li><pre><code>    &quot;C&quot;: &quot;&lt;country&gt;&quot;,
    &quot;ST&quot;: &quot;&lt;state&gt;&quot;,
    &quot;L&quot;: &quot;&lt;city&gt;&quot;,
    &quot;O&quot;: &quot;&lt;organization&gt;&quot;,
    &quot;OU&quot;: &quot;&lt;organization unit&gt;&quot;
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">注：不同证书 csr 文件的 CN、C、ST、L、O、OU 组合必须不同，否则可能出现 PEER&#39;S CERTIFICATE HAS AN INVALID SIGNATURE 错误；后续创建证书的 csr 文件时，CN 都不相同（C、ST、L、O、OU 相同），以达到区分的目的。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**生成 CA 密钥（&#96;ca-key.pem&#96;）和证书（&#96;ca.pem&#96;）**</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;shell</span><br><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line">ls ca*</span><br><span class="line"></span><br><span class="line"># 查看证书</span><br><span class="line">openssl x509 -noout -text -in ca.pem</span><br><span class="line"># 查看私钥</span><br><span class="line">openssl rsa -noout -text -in ca-key.pem</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ul>
<p><strong>分发证书文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;mkdir -p &#x2F;etc&#x2F;kubernetes&#x2F;cert&quot;</span><br><span class="line">    scp ca*.pem ca-config.json root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;kubernetes&#x2F;cert</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<h1 id="4、部署Kubectl工具"><a href="#4、部署Kubectl工具" class="headerlink" title="4、部署Kubectl工具"></a>4、部署Kubectl工具</h1><p>注：本小节介绍安装和配置 kubernetes 命令行管理工具 kubectl 的步骤。本小节只需要部署一次，生成的 kubeconfig 文件是通用的，可以拷贝到需要执行 kubectl 命令的机器的 ~/.kube/config 位置。</p>
<p>注：如果没有特殊指明，本小节所有操作均在 <strong>Kubernetes-01</strong> 节点上执行。</p>
<p><strong>下载Kubectl二进制文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line"></span><br><span class="line"># 自行解决翻墙下载问题</span><br><span class="line">wget https:&#x2F;&#x2F;dl.k8s.io&#x2F;v1.16.8&#x2F;kubernetes-client-linux-amd64.tar.gz </span><br><span class="line">tar -xzvf kubernetes-client-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>


<p>分发到所有使用 kubectl 工具的节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp kubernetes&#x2F;client&#x2F;bin&#x2F;kubectl root@$&#123;node_ip&#125;:&#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;chmod +x &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;*&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>创建admin证书和私钥</strong></p>
<p>kubectl 使用 https 协议与 kube-apiserver 进行安全通信，kube-apiserver 对 kubectl 请求包含的证书进行认证和授权。kubectl 后续用于集群管理，所以这里创建具有<strong>最高权限</strong>的 admin 证书。</p>
<p>创建证书签名请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cat &gt; admin-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;admin&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;z0ukun&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>O: system:masters：kube-apiserver 收到使用该证书的客户端请求后，为请求添加组（Group）认证标识 system:masters；</li>
<li>预定义的 ClusterRoleBinding cluster-admin 将 Group system:masters 与 Role cluster-admin 绑定，该 Role 授予操作集群所需的最高权限；</li>
<li>该证书只会被 kubectl 当做 client 证书使用，所以 hosts 字段为空。</li>
</ul>
<p><strong>生成证书和私钥：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cfssl gencert -ca&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca.pem \</span><br><span class="line">  -ca-key&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca-key.pem \</span><br><span class="line">  -config&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca-config.json \</span><br><span class="line">  -profile&#x3D;kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line">ls admin*</span><br></pre></td></tr></table></figure>
<p>注：忽略警告消息： [WARNING] This certificate lacks a “hosts” field。</p>
<p><strong>创建 kubeconfig 文件</strong></p>
<p>kubectl 使用 kubeconfig 文件访问 apiserver，该文件包含 kube-apiserver 的地址和认证信息（CA 证书和客户端证书）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line"></span><br><span class="line"># 设置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --server&#x3D;https:&#x2F;&#x2F;$&#123;NODE_IPS[0]&#125;:6443 \</span><br><span class="line">  --kubeconfig&#x3D;kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials admin \</span><br><span class="line">  --client-certificate&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;admin.pem \</span><br><span class="line">  --client-key&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;admin-key.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --kubeconfig&#x3D;kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context kubernetes \</span><br><span class="line">  --cluster&#x3D;kubernetes \</span><br><span class="line">  --user&#x3D;admin \</span><br><span class="line">  --kubeconfig&#x3D;kubectl.kubeconfig</span><br><span class="line"></span><br><span class="line"># 设置默认上下文</span><br><span class="line">kubectl config use-context kubernetes --kubeconfig&#x3D;kubectl.kubeconfig</span><br></pre></td></tr></table></figure>
<ul>
<li>–certificate-authority：验证 kube-apiserver 证书的根证书；</li>
<li>–client-certificate、–client-key：刚生成的 admin 证书和私钥，与 kube-apiserver https 通信时使用；</li>
<li>–embed-certs=true：将 ca.pem 和 admin.pem 证书内容嵌入到生成的 kubectl.kubeconfig 文件中(否则，写入的是证书文件路径，后续拷贝 kubeconfig 到其它机器时，还需要单独拷贝证书文件，不方便。)；</li>
<li>–server：指定 kube-apiserver 的地址，这里指向第一个节点上的服务。</li>
</ul>
<p><strong>分发 kubeconfig 文件</strong></p>
<p>分发到所有使用 kubectl 命令的节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;mkdir -p ~&#x2F;.kube&quot;</span><br><span class="line">    scp kubectl.kubeconfig root@$&#123;node_ip&#125;:~&#x2F;.kube&#x2F;config</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<h1 id="5、部署Etcd集群"><a href="#5、部署Etcd集群" class="headerlink" title="5、部署Etcd集群"></a>5、部署Etcd集群</h1><p>etcd 是基于 Raft 的分布式 KV 存储系统，由 CoreOS 开发，常用于服务发现、共享配置以及并发控制（如 leader 选举、分布式锁等）；kubernetes 使用 etcd 集群持久化存储所有 API 对象、运行数据。</p>
<p>本小节介绍如何部署一个三节点高可用 etcd 集群的步骤：</p>
<ul>
<li>下载和分发 etcd 二进制文件；</li>
<li>创建 etcd 集群各节点的 x509 证书，用于加密客户端(如 etcdctl) 与 etcd 集群、etcd 集群之间的通信；</li>
<li>创建 etcd 的 systemd unit 文件，配置服务参数；</li>
<li>检查集群工作状态；</li>
</ul>
<p>etcd 集群节点名称和 IP 如下：</p>
<ul>
<li>Kubernetes-01：172.16.200.11</li>
<li>Kubernetes-02：172.16.200.12</li>
<li>Kubernetes-03：172.16.200.13</li>
</ul>
<p>注：如果没有特殊指明，本小节所有操作<strong>均在 Kubernetes-01 节点上执行</strong>；需要特别注意 flanneld 与本小节安装的 etcd v3.4.x 不兼容，如果要安装 flanneld（如果网络使用 calio 则不需要修改），则需要将 etcd <strong>降级到 v3.3.x 版本</strong>。</p>
<p><strong>下载etcd二进制文件</strong></p>
<p>etcd下载地址：<a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://github.com/etcd-io/etcd/releases">https://github.com/etcd-io/etcd/releases</a></p>
<p>这里我们为了兼容Flannel网络插件、安装etcd v3.3.20版本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;coreos&#x2F;etcd&#x2F;releases&#x2F;download&#x2F;v3.3.20&#x2F;etcd-v3.3.20-linux-amd64.tar.gz</span><br><span class="line">tar -xvf etcd-v3.3.20-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>


<p><strong>分发二进制文件到集群所有节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp &#x2F;opt&#x2F;k8s&#x2F;work&#x2F;etcd-v3.3.20-linux-amd64&#x2F;etcd* root@$&#123;node_ip&#125;:&#x2F;opt&#x2F;k8s&#x2F;bin</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;chmod +x &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;*&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>创建etcd证书和私钥</strong></p>
<p>创建证书签名请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cat &gt; etcd-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">  &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;172.16.200.11&quot;,</span><br><span class="line">    &quot;172.16.200.12&quot;,</span><br><span class="line">    &quot;172.16.200.13&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;z0ukun&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>hosts：指定授权使用该证书的 etcd 节点 IP 列表，需要将 etcd 集群所有节点 IP 都列在其中。</li>
</ul>
<p><strong>生成证书和私钥：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cfssl gencert -ca&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca.pem \</span><br><span class="line">    -ca-key&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca-key.pem \</span><br><span class="line">    -config&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca-config.json \</span><br><span class="line">    -profile&#x3D;kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line">ls etcd*pem</span><br></pre></td></tr></table></figure>


<p><strong>分发生成的证书和私钥到各 etcd 节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;mkdir -p &#x2F;etc&#x2F;etcd&#x2F;cert&quot;</span><br><span class="line">    scp etcd*.pem root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;etcd&#x2F;cert&#x2F;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>创建etcd的systemd unit模板文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">cat &gt; etcd.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Documentation=https://github.com/coreos</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=$&#123;ETCD_DATA_DIR&#125;</span><br><span class="line">ExecStart=/opt/k8s/bin/etcd \\</span><br><span class="line">  --data-dir=$&#123;ETCD_DATA_DIR&#125; \\ # 数据目录</span><br><span class="line">  --wal-dir=$&#123;ETCD_WAL_DIR&#125; \\   # 预写日志目录</span><br><span class="line">  --name=##NODE_NAME## \\        # 节点名，这个名字和主机名没关系，可以和主机名不一样</span><br><span class="line">  --cert-file=/etc/etcd/cert/etcd.pem \\    # 公钥，client端连接用</span><br><span class="line">  --key-file=/etc/etcd/cert/etcd-key.pem \\ # 私钥，client端连接用</span><br><span class="line">  --trusted-ca-file=/etc/kubernetes/cert/ca.pem \\  # 可信的CA证书（公钥），client端连接用</span><br><span class="line">  --peer-cert-file=/etc/etcd/cert/etcd.pem \\    # 公钥，etcd节点间用</span><br><span class="line">  --peer-key-file=/etc/etcd/cert/etcd-key.pem \\ # 私钥，etcd节点间用</span><br><span class="line">  --peer-trusted-ca-file=/etc/kubernetes/cert/ca.pem \\ # 可信的CA证书（公钥），etcd节点间用</span><br><span class="line">  --peer-client-cert-auth \\</span><br><span class="line">  --client-cert-auth \\</span><br><span class="line">  --listen-peer-urls=https://##NODE_IP##:2380 \\</span><br><span class="line">  --initial-advertise-peer-urls=https://##NODE_IP##:2380 \\</span><br><span class="line">  --listen-client-urls=https://##NODE_IP##:2379,http://127.0.0.1:2379 \\</span><br><span class="line">  --advertise-client-urls=https://##NODE_IP##:2379 \\</span><br><span class="line">  --initial-cluster-token=etcd-cluster-0 \\</span><br><span class="line">  --initial-cluster=$&#123;ETCD_NODES&#125; \\</span><br><span class="line">  --initial-cluster-state=new \\</span><br><span class="line">  --auto-compaction-mode=periodic \\</span><br><span class="line">  --auto-compaction-retention=1 \\ # 历史数据多长时间压缩一次，1表示1个小时</span><br><span class="line">  --max-request-bytes=33554432 \\  # etcd Raft消息最大字节数，ETCD默认该值为1.5M，官方推荐10M</span><br><span class="line">  --quota-backend-bytes=6442450944 \\ # ETCDdb数据大小，默认是２G,当数据达到２G的时候就不允许写入，必须对历史数据进行压缩才能继续写入，官方推荐8G</span><br><span class="line">  --heartbeat-interval=250 \\ # 心跳间隔时间 (单位 毫秒)，默认: &quot;100&quot;</span><br><span class="line">  --election-timeout=2000     # 选举超时时间(单位 毫秒)，默认: &quot;1000&quot;</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223529225.png" alt="image-20210114223529225"></p>
<ul>
<li>WorkingDirectory、–data-dir：指定工作目录和数据目录为 ${ETCD_DATA_DIR}，需在启动服务前创建这个目录；</li>
<li>–wal-dir：指定 wal 目录，为了提高性能，一般使用 SSD 或者和 –data-dir 不同的磁盘；</li>
<li>–name：指定节点名称，当 –initial-cluster-state 值为 new 时，–name 的参数值必须位于 –initial-cluster 列表中；</li>
<li>–cert-file、–key-file：etcd server 与 client 通信时使用的证书和私钥；</li>
<li>–trusted-ca-file：签名 client 证书的 CA 证书，用于验证 client 证书；</li>
<li>–peer-cert-file、–peer-key-file：etcd 与 peer 通信使用的证书和私钥；</li>
<li>–peer-trusted-ca-file：签名 peer 证书的 CA 证书，用于验证 peer 证书。</li>
</ul>
<p><strong>为各节点创建和分发 etcd systemd unit 文件</strong></p>
<p>替换模板文件中的变量，为各节点创建 systemd unit 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for (( i&#x3D;0; i &lt; 3; i++ ))</span><br><span class="line">  do</span><br><span class="line">    sed -e &quot;s&#x2F;##NODE_NAME##&#x2F;$&#123;NODE_NAMES[i]&#125;&#x2F;&quot; -e &quot;s&#x2F;##NODE_IP##&#x2F;$&#123;NODE_IPS[i]&#125;&#x2F;&quot; etcd.service.template &gt; etcd-$&#123;NODE_IPS[i]&#125;.service </span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">ls *.service</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223535568.png" alt="image-20210114223535568"></p>
<ul>
<li>NODE_NAMES 和 NODE_IPS 为相同长度的 bash 数组，分别为节点名称和对应的 IP。</li>
</ul>
<p><strong>分发生成的 systemd unit 文件：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp etcd-$&#123;node_ip&#125;.service root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;etcd.service</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>启动etcd服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;mkdir -p $&#123;ETCD_DATA_DIR&#125; $&#123;ETCD_WAL_DIR&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;systemctl daemon-reload &amp;&amp; systemctl enable etcd &amp;&amp; systemctl restart etcd &quot; &amp;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<ul>
<li>切记必须先创建 etcd 数据目录和工作目录;</li>
<li>etcd 进程首次启动时会等待其它节点的 etcd 加入集群，命令 systemctl start etcd 会卡住一段时间，为正常现象。</li>
</ul>
<p><strong>检查启动结果</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;systemctl status etcd|grep Active&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<p>注：确保状态为 active (running)，否则可以通过 journalctl -u etcd 查看日志，确认原因。</p>
<p><strong>验证服务状态</strong></p>
<p>部署完 etcd 集群后，在任一 etcd 节点上执行如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;etcdctl \</span><br><span class="line">    --endpoints&#x3D;https:&#x2F;&#x2F;$&#123;node_ip&#125;:2379 \</span><br><span class="line">    --ca-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">    --cert-file&#x3D;&#x2F;etc&#x2F;etcd&#x2F;cert&#x2F;etcd.pem \</span><br><span class="line">    --key-file&#x3D;&#x2F;etc&#x2F;etcd&#x2F;cert&#x2F;etcd-key.pem cluster-health</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<ul>
<li>3.4.X 版本的 etcd/etcdctl 默认启用了 V3 API，所以执行 etcdctl 命令时不需要再指定环境变量 ETCDCTL_API=3；</li>
<li>从 K8S 1.13 开始，不再支持 v2 版本的 etcd。</li>
</ul>
<p>预期输出：</p>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223542034.png" alt="image-20210114223542034"></p>
<p>输出均为 healthy 时表示集群服务正常。</p>
<p><strong>查看当前的leader</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">etcdctl --endpoints=https://192.168.10.20:2379 --ca-file=/etc/kubernetes/cert/ca.pem --cert-file=/etc/etcd/cert/etcd.pem --key-file=/etc/etcd/cert/etcd-key.pem member list</span><br></pre></td></tr></table></figure>
<p>输出信息如下：</p>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223548228.png" alt="image-20210114223548228"></p>
<h1 id="6、部署Master集群"><a href="#6、部署Master集群" class="headerlink" title="6、部署Master集群"></a>6、部署Master集群</h1><p>kubernetes master 节点运行如下组件：</p>
<ul>
<li>kube-apiserver</li>
<li>kube-scheduler</li>
<li>kube-controller-manager</li>
</ul>
<p>kube-apiserver、kube-scheduler 和 kube-controller-manager 均以多实例模式运行：</p>
<ul>
<li>kube-scheduler 和 kube-controller-manager 会自动选举产生一个 leader 实例，其它实例处于阻塞模式，当 leader 挂了后，重新选举产生新的 leader，从而保证服务可用性；</li>
<li>kube-apiserver 是无状态的，可以通过 kube-nginx 进行代理访问，从而保证服务可用性；</li>
</ul>
<p>注：如果没有特殊指明，本小节所有操作均在 <strong>Kubernetes-01</strong> 节点上执行。</p>
<p><strong>下载最新版本二进制文件</strong></p>
<p>Kubernetes v1.16.8下载地址：<a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://github.com/kubernetes/kubernetes/tree/v1.16.8">https://github.com/kubernetes/kubernetes/tree/v1.16.8</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 自行解决翻墙问题</span></span><br><span class="line">wget https://dl.k8s.io/v1.16.8/kubernetes-server-linux-amd64.tar.gz  </span><br><span class="line">tar -xzvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">cd kubernetes</span><br><span class="line">tar -xzvf  kubernetes-src.tar.gz</span><br></pre></td></tr></table></figure>


<p><strong>将二进制文件拷贝到所有 master 节点：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp kubernetes/server/bin/&#123;apiextensions-apiserver,kube-apiserver,kube-controller-manager,kube-proxy,kube-scheduler,kubeadm,kubectl,kubelet,mounter&#125; root@$&#123;node_ip&#125;:/opt/k8s/bin/</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;chmod +x /opt/k8s/bin/*&quot;</span><br><span class="line">  done </span><br></pre></td></tr></table></figure>
<h2 id="6-1、APIServer集群"><a href="#6-1、APIServer集群" class="headerlink" title="6.1、APIServer集群"></a>6.1、APIServer集群</h2><p>注：本小节讲解部署一个三实例 kube-apiserver 集群的步骤。如果没有特殊指明，本小节所有操作<strong>均在Kubernetes-01 节点上执行</strong>。</p>
<p><strong>创建 kubernetes-master 证书和私钥</strong></p>
<p>创建证书签名请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">cat &gt; kubernetes-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes-master&quot;,</span><br><span class="line">  &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;172.16.200.11&quot;,</span><br><span class="line">    &quot;172.16.200.12&quot;,</span><br><span class="line">    &quot;172.16.200.13&quot;,</span><br><span class="line">    &quot;$&#123;CLUSTER_KUBERNETES_SVC_IP&#125;&quot;,</span><br><span class="line">    &quot;kubernetes&quot;,</span><br><span class="line">    &quot;kubernetes.default&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc.cluster.local.&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc.$&#123;CLUSTER_DNS_DOMAIN&#125;.&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;z0ukun&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223602205.png" alt="image-20210114223602205"></p>
<ul>
<li>hosts 字段指定授权使用该证书的 <strong>IP 和域名列表</strong>，这里列出了 master 节点 IP、kubernetes 服务的 IP 和域名；</li>
</ul>
<p><strong>生成证书和私钥：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca.pem \</span><br><span class="line">  -ca-key&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca-key.pem \</span><br><span class="line">  -config&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca-config.json \</span><br><span class="line">  -profile&#x3D;kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span><br><span class="line">ls kubernetes*pem</span><br></pre></td></tr></table></figure>


<p><strong>将生成的证书和私钥文件拷贝到所有 master 节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;mkdir -p &#x2F;etc&#x2F;kubernetes&#x2F;cert&quot;</span><br><span class="line">    scp kubernetes*.pem root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>创建加密配置文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">cat &gt; encryption-config.yaml &lt;&lt;EOF</span><br><span class="line">kind: EncryptionConfig</span><br><span class="line">apiVersion: v1</span><br><span class="line">resources:</span><br><span class="line">  - resources:</span><br><span class="line">      - secrets</span><br><span class="line">    providers:</span><br><span class="line">      - aescbc:</span><br><span class="line">          keys:</span><br><span class="line">            - name: key1</span><br><span class="line">              secret: $&#123;ENCRYPTION_KEY&#125;</span><br><span class="line">      - identity: &#123;&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>


<p><strong>将加密配置文件拷贝到所有 master 节点的 /etc/kubernetes 目录下：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp encryption-config.yaml root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;kubernetes&#x2F;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>创建审计策略文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">cat &gt; audit-policy.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: audit.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: Policy</span><br><span class="line">rules:</span><br><span class="line">  # The following requests were manually identified as high-volume and low-risk, so drop them.</span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: &quot;&quot;</span><br><span class="line">        resources:</span><br><span class="line">          - endpoints</span><br><span class="line">          - services</span><br><span class="line">          - services&#x2F;status</span><br><span class="line">    users:</span><br><span class="line">      - &#39;system:kube-proxy&#39;</span><br><span class="line">    verbs:</span><br><span class="line">      - watch</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: &quot;&quot;</span><br><span class="line">        resources:</span><br><span class="line">          - nodes</span><br><span class="line">          - nodes&#x2F;status</span><br><span class="line">    userGroups:</span><br><span class="line">      - &#39;system:nodes&#39;</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    namespaces:</span><br><span class="line">      - kube-system</span><br><span class="line">    resources:</span><br><span class="line">      - group: &quot;&quot;</span><br><span class="line">        resources:</span><br><span class="line">          - endpoints</span><br><span class="line">    users:</span><br><span class="line">      - &#39;system:kube-controller-manager&#39;</span><br><span class="line">      - &#39;system:kube-scheduler&#39;</span><br><span class="line">      - &#39;system:serviceaccount:kube-system:endpoint-controller&#39;</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - update</span><br><span class="line"></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: &quot;&quot;</span><br><span class="line">        resources:</span><br><span class="line">          - namespaces</span><br><span class="line">          - namespaces&#x2F;status</span><br><span class="line">          - namespaces&#x2F;finalize</span><br><span class="line">    users:</span><br><span class="line">      - &#39;system:apiserver&#39;</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line"></span><br><span class="line">  # Don&#39;t log HPA fetching metrics.</span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">    users:</span><br><span class="line">      - &#39;system:kube-controller-manager&#39;</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line"></span><br><span class="line">  # Don&#39;t log these read-only URLs.</span><br><span class="line">  - level: None</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">      - &#39;&#x2F;healthz*&#39;</span><br><span class="line">      - &#x2F;version</span><br><span class="line">      - &#39;&#x2F;swagger*&#39;</span><br><span class="line"></span><br><span class="line">  # Don&#39;t log events requests.</span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">      - group: &quot;&quot;</span><br><span class="line">        resources:</span><br><span class="line">          - events</span><br><span class="line"></span><br><span class="line">  # node and pod status calls from nodes are high-volume and can be large, don&#39;t log responses</span><br><span class="line">  # for expected updates from nodes</span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: &quot;&quot;</span><br><span class="line">        resources:</span><br><span class="line">          - nodes&#x2F;status</span><br><span class="line">          - pods&#x2F;status</span><br><span class="line">    users:</span><br><span class="line">      - kubelet</span><br><span class="line">      - &#39;system:node-problem-detector&#39;</span><br><span class="line">      - &#39;system:serviceaccount:kube-system:node-problem-detector&#39;</span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">      - patch</span><br><span class="line"></span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: &quot;&quot;</span><br><span class="line">        resources:</span><br><span class="line">          - nodes&#x2F;status</span><br><span class="line">          - pods&#x2F;status</span><br><span class="line">    userGroups:</span><br><span class="line">      - &#39;system:nodes&#39;</span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">      - patch</span><br><span class="line"></span><br><span class="line">  # deletecollection calls can be large, don&#39;t log responses for expected namespace deletions</span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    users:</span><br><span class="line">      - &#39;system:serviceaccount:kube-system:namespace-controller&#39;</span><br><span class="line">    verbs:</span><br><span class="line">      - deletecollection</span><br><span class="line"></span><br><span class="line">  # Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,</span><br><span class="line">  # so only log at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: &quot;&quot;</span><br><span class="line">        resources:</span><br><span class="line">          - secrets</span><br><span class="line">          - configmaps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">        resources:</span><br><span class="line">          - tokenreviews</span><br><span class="line">  # Get repsonses can be large; skip them.</span><br><span class="line">  - level: Request</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: &quot;&quot;</span><br><span class="line">      - group: admissionregistration.k8s.io</span><br><span class="line">      - group: apiextensions.k8s.io</span><br><span class="line">      - group: apiregistration.k8s.io</span><br><span class="line">      - group: apps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">      - group: authorization.k8s.io</span><br><span class="line">      - group: autoscaling</span><br><span class="line">      - group: batch</span><br><span class="line">      - group: certificates.k8s.io</span><br><span class="line">      - group: extensions</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">      - group: networking.k8s.io</span><br><span class="line">      - group: policy</span><br><span class="line">      - group: rbac.authorization.k8s.io</span><br><span class="line">      - group: scheduling.k8s.io</span><br><span class="line">      - group: settings.k8s.io</span><br><span class="line">      - group: storage.k8s.io</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line"></span><br><span class="line">  # Default level for known APIs</span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">    resources:</span><br><span class="line">      - group: &quot;&quot;</span><br><span class="line">      - group: admissionregistration.k8s.io</span><br><span class="line">      - group: apiextensions.k8s.io</span><br><span class="line">      - group: apiregistration.k8s.io</span><br><span class="line">      - group: apps</span><br><span class="line">      - group: authentication.k8s.io</span><br><span class="line">      - group: authorization.k8s.io</span><br><span class="line">      - group: autoscaling</span><br><span class="line">      - group: batch</span><br><span class="line">      - group: certificates.k8s.io</span><br><span class="line">      - group: extensions</span><br><span class="line">      - group: metrics.k8s.io</span><br><span class="line">      - group: networking.k8s.io</span><br><span class="line">      - group: policy</span><br><span class="line">      - group: rbac.authorization.k8s.io</span><br><span class="line">      - group: scheduling.k8s.io</span><br><span class="line">      - group: settings.k8s.io</span><br><span class="line">      - group: storage.k8s.io</span><br><span class="line">      </span><br><span class="line">  # Default level for all other requests.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    omitStages:</span><br><span class="line">      - RequestReceived</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>


<p><strong>分发审计策略文件：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp audit-policy.yaml root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;kubernetes&#x2F;audit-policy.yaml</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>创建后续访问 metrics-server 或 kube-prometheus 使用的证书</strong></p>
<p>创建证书签名请求:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">cat &gt; proxy-client-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;aggregator&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;z0ukun&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>CN 名称需要位于 kube-apiserver 的 –requestheader-allowed-names 参数中，否则后续访问 metrics 时会提示权限不足，在配置 kube-apiserver  的 systems unit 文件时，注意这点</li>
</ul>
<p><strong>生成证书和私钥：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  -ca-key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;ca-key.pem  \</span><br><span class="line">  -config&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;ca-config.json  \</span><br><span class="line">  -profile&#x3D;kubernetes proxy-client-csr.json | cfssljson -bare proxy-client</span><br><span class="line">ls proxy-client*.pem</span><br></pre></td></tr></table></figure>


<p><strong>将生成的证书和私钥文件拷贝到所有 master 节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp proxy-client*.pem root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>创建 kube-apiserver systemd unit 模板文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">cat &gt; kube-apiserver.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=$&#123;K8S_DIR&#125;/kube-apiserver</span><br><span class="line">ExecStart=/opt/k8s/bin/kube-apiserver \\</span><br><span class="line">  --advertise-address=##NODE_IP## \\ </span><br><span class="line">  --default-not-ready-toleration-seconds=360 \\</span><br><span class="line">  --default-unreachable-toleration-seconds=360 \\</span><br><span class="line">  --feature-gates=DynamicAuditing=true \\</span><br><span class="line">  --max-mutating-requests-inflight=2000 \\</span><br><span class="line">  --max-requests-inflight=4000 \\</span><br><span class="line">  --default-watch-cache-size=200 \\</span><br><span class="line">  --delete-collection-workers=2 \\</span><br><span class="line">  --encryption-provider-config=/etc/kubernetes/encryption-config.yaml \\</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/cert/kubernetes.pem \\</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/cert/kubernetes-key.pem \\</span><br><span class="line">  --etcd-servers=$&#123;ETCD_ENDPOINTS&#125; \\</span><br><span class="line">  --bind-address=##NODE_IP## \\</span><br><span class="line">  --secure-port=6443 \\</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/cert/kubernetes.pem \\</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/cert/kubernetes-key.pem \\</span><br><span class="line">  --insecure-port=0 \\</span><br><span class="line">  --audit-dynamic-configuration \\</span><br><span class="line">  --audit-log-maxage=15 \\</span><br><span class="line">  --audit-log-maxbackup=3 \\</span><br><span class="line">  --audit-log-maxsize=100 \\</span><br><span class="line">  --audit-log-truncate-enabled \\</span><br><span class="line">  --audit-log-path=$&#123;K8S_DIR&#125;/kube-apiserver/audit.log \\</span><br><span class="line">  --audit-policy-file=/etc/kubernetes/audit-policy.yaml \\</span><br><span class="line">  --profiling \\</span><br><span class="line">  --anonymous-auth=false \\</span><br><span class="line">  --client-ca-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --enable-bootstrap-token-auth \\</span><br><span class="line">  --requestheader-allowed-names=&quot;aggregator&quot; \\</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --requestheader-extra-headers-prefix=&quot;X-Remote-Extra-&quot; \\</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \\</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --authorization-mode=Node,RBAC \\</span><br><span class="line">  --runtime-config=api/all=true \\</span><br><span class="line">  --enable-admission-plugins=NodeRestriction \\</span><br><span class="line">  --allow-privileged=true \\</span><br><span class="line">  --apiserver-count=3 \\</span><br><span class="line">  --event-ttl=168h \\</span><br><span class="line">  --kubelet-certificate-authority=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/cert/kubernetes.pem \\</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/cert/kubernetes-key.pem \\</span><br><span class="line">  --kubelet-https=true \\</span><br><span class="line">  --kubelet-timeout=10s \\</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/cert/proxy-client.pem \\</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/cert/proxy-client-key.pem \\</span><br><span class="line">  --service-cluster-ip-range=$&#123;SERVICE_CIDR&#125; \\</span><br><span class="line">  --service-node-port-range=$&#123;NODE_PORT_RANGE&#125; \\</span><br><span class="line">  --logtostderr=true \\</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">--advertise-address：向集群成员通知 apiserver 消息的 IP 地址。这个地址必须能够被集群中其他成员访问。如果 IP 地址为空，将会使用 --bind-address，如果未指定 --bind-address，将会使用主机的默认接口地址。</span><br><span class="line"></span><br><span class="line">--default-not-ready-toleration-seconds：表示 `notReady` 状态的容忍度秒数：默认情况下，`NoExecute` 被添加到尚未具有此容忍度的每个 Pod 中。</span><br><span class="line"></span><br><span class="line">--default-unreachable-toleration-seconds：表示 `unreachable` 状态的容忍度秒数：默认情况下，`NoExecute` 被添加到尚未具有此容忍度的每个 Pod 中。</span><br><span class="line"></span><br><span class="line">--feature-gates：一个描述 alpha/experimental 特性开关的键值对列表</span><br><span class="line"></span><br><span class="line">--max-mutating-requests-inflight：在给定时间内进行中可变请求的最大数量。当超过该值时，服务将拒绝所有请求。0 值表示没有限制。（默认值 200）</span><br><span class="line"></span><br><span class="line">--max-requests-inflight：在给定时间内进行中不可变请求的最大数量。当超过该值时，服务将拒绝所有请求。0 值表示没有限制。（默认值 400）</span><br><span class="line"></span><br><span class="line">--default-watch-cache-size：默认监视缓存大小。如果为零，则对未设置默认监视大小的资源禁用监视缓存。</span><br><span class="line"></span><br><span class="line">--delete-collection-workers：用于 DeleteCollection 调用的工作者数量。这被用于加速 namespace 的清理。( 默认值 1)</span><br><span class="line"></span><br><span class="line">--encryption-provider-config：包含用于在etcd中存储secret 的encryption providers的配置文件</span><br><span class="line"></span><br><span class="line">--etcd-*：访问 etcd 的证书和 etcd 服务器地址；</span><br><span class="line"></span><br><span class="line">--bind-address： https 监听的 IP，不能为 127.0.0.1，否则外界不能访问它的安全端口 6443；</span><br><span class="line"></span><br><span class="line">--secret-port：https 监听端口；</span><br><span class="line"></span><br><span class="line">--tls-*-file：指定 apiserver 使用的证书、私钥和 CA 文件；</span><br><span class="line"></span><br><span class="line">--insecure-port=0：关闭监听 http 非安全端口(8080)；</span><br><span class="line"></span><br><span class="line">--audit-dynamic-configuration：启用动态审计配置</span><br><span class="line"></span><br><span class="line">--audit-*：配置审计策略和审计日志文件相关的参数；</span><br><span class="line"></span><br><span class="line">--profiling：在 web 接口 host:port/debug/pprof/ 上启用 profiling。（默认值 true）</span><br><span class="line"> </span><br><span class="line">-anonymous-auth：启用到 API server 的安全端口的匿名请求。未被其他认证方法拒绝的请求被当做匿名请求。匿名请求的用户名为 system:anonymous，用户组名为 system:unauthenticated。（默认值 true）</span><br><span class="line"></span><br><span class="line">--client-ca-file：验证客户端请求证书的根证书文件</span><br><span class="line"></span><br><span class="line">--enable-bootstrap-token-auth：启用 kubelet bootstrap 的 token 认证；</span><br><span class="line"></span><br><span class="line">--requestheader-allowed-names：使用 --requestheader-username-headers 指定的，允许在头部提供用户名的客户端证书通用名称列表。如果为空，任何通过 --requestheader-client-ca-file 中 authorities 验证的客户端证书都是被允许的。</span><br><span class="line"></span><br><span class="line">--requestheader-*：kube-apiserver 的 aggregator layer 相关的配置参数，proxy-client &amp; HPA 需要使用；</span><br><span class="line"></span><br><span class="line">--service-account-key-file：签名 ServiceAccount Token 的公钥文件，kube-controller-manager 的 --service-account-private-key-file 指定私钥文件，两者配对使用；</span><br><span class="line"></span><br><span class="line">--authorization-mode：在安全端口上进行权限验证的插件的顺序列表。以逗号分隔的列表，包括：AlwaysAllow,AlwaysDeny,ABAC,Webhook,RBAC,Node.（默认值 &quot;AlwaysAllow&quot;）</span><br><span class="line"></span><br><span class="line">--runtime-config=api/all=true： 启用所有版本的 APIs，如 autoscaling/v2alpha1；</span><br><span class="line"></span><br><span class="line">--enable-admission-plugins：启用一些默认关闭的 plugins；</span><br><span class="line"></span><br><span class="line">--allow-privileged：运行执行 privileged 权限的容器；</span><br><span class="line"></span><br><span class="line">--apiserver-count=3：指定 apiserver 实例的数量；</span><br><span class="line"></span><br><span class="line">--event-ttl：指定 events 的保存时间；</span><br><span class="line"></span><br><span class="line">--kubelet-*：如果指定，则使用 https 访问 kubelet APIs；需要为证书对应的用户(上面 kubernetes*.pem 证书的用户为 kubernetes) 用户定义 RBAC 规则，否则访问 kubelet API 时提示未授权；</span><br><span class="line"></span><br><span class="line">--proxy-client-*：apiserver 访问 metrics-server 使用的证书；</span><br><span class="line"></span><br><span class="line">--service-cluster-ip-range： 指定 Service Cluster IP 地址段；</span><br><span class="line"></span><br><span class="line">--service-node-port-range： 指定 NodePort 的端口范围；</span><br><span class="line"></span><br><span class="line">--logtostderr：日志输出到 stderr 而不是文件中</span><br><span class="line"></span><br><span class="line">--v=2：指定输出日志的日志详细级别</span><br></pre></td></tr></table></figure>
<p>注：如果 kube-apiserver 机器没有运行 kube-proxy，则还需要添加 –enable-aggregator-routing=true 参数；</p>
<p>关于 –requestheader-XXX 相关参数，参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://github.com/kubernetes-incubator/apiserver-builder/blob/master/docs/concepts/auth.md">https://github.com/kubernetes-incubator/apiserver-builder/blob/master/docs/concepts/auth.md</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://docs.bitnami.com/kubernetes/how-to/configure-autoscaling-custom-metrics/">https://docs.bitnami.com/kubernetes/how-to/configure-autoscaling-custom-metrics/</a></li>
</ul>
<p>注： –requestheader-client-ca-file 指定的 CA 证书，必须具有 client auth and server auth； 如果 –requestheader-allowed-names 不为空,且 –proxy-client-cert-file 证书的 CN 名称不在 allowed-names 中，则后续查看 node 或 pods 的 metrics 失败</p>
<p><strong>为各节点创建和分发 kube-apiserver systemd unit 文件</strong></p>
<p>替换模板文件中的变量，为各节点生成 systemd unit 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for (( i&#x3D;0; i &lt; 3; i++ ))</span><br><span class="line">  do</span><br><span class="line">    sed -e &quot;s&#x2F;##NODE_NAME##&#x2F;$&#123;NODE_NAMES[i]&#125;&#x2F;&quot; -e &quot;s&#x2F;##NODE_IP##&#x2F;$&#123;NODE_IPS[i]&#125;&#x2F;&quot; kube-apiserver.service.template &gt; kube-apiserver-$&#123;NODE_IPS[i]&#125;.service </span><br><span class="line">  done</span><br><span class="line">ls kube-apiserver*.service</span><br></pre></td></tr></table></figure>
<ul>
<li>NODE_NAMES 和 NODE_IPS 为相同长度的 bash 数组，分别为节点名称和对应的 IP；</li>
</ul>
<p><strong>分发生成的 systemd unit 文件：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp kube-apiserver-$&#123;node_ip&#125;.service root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;kube-apiserver.service</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>启动 kube-apiserver 服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;mkdir -p $&#123;K8S_DIR&#125;&#x2F;kube-apiserver&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver &amp;&amp; systemctl restart kube-apiserver&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>检查 kube-apiserver 运行状态</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;systemctl status kube-apiserver |grep &#39;Active:&#39;&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>检查集群状态</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 查看集群信息</span><br><span class="line">kubectl cluster-info</span><br><span class="line"></span><br><span class="line"># 查看所有的命令空间</span><br><span class="line">kubectl get all --all-namespaces</span><br><span class="line"></span><br><span class="line"># 查看组件状态</span><br><span class="line">kubectl get componentstatuses</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223615014.png" alt="image-20210114223615014"></p>
<p>注：原作者说：<strong>Kubernetes 1.16.8 存在 Bugs 导致返回结果一直为 <unknown>，但 kubectl get cs -o yaml 可以返回正确结果</strong>。</p>
<p>我查阅了相关资料发现、正确的解释如下：在k8s.io/kubernetes/pkg/registry/core/componentstatus/rest.go中，没有实现rest.TableConvertor接口，所以componentStatuses的handler的RequestScope中的TableConvertor字段就为空，最终导致了问题。详细流程和问题点大家可以参考下面的文章</p>
<p><strong>如果希望打印和原来类似的内容，目前只有通过下面的模板来打印：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs -o&#x3D;go-template&#x3D;&#39;&#123;&#123;printf &quot;|NAME|STATUS|MESSAGE|\n&quot;&#125;&#125;&#123;&#123;range .items&#125;&#125;&#123;&#123;$name :&#x3D; .metadata.name&#125;&#125;&#123;&#123;range .conditions&#125;&#125;&#123;&#123;printf &quot;|%s|%s|%s|\n&quot; $name .status .message&#125;&#125;&#123;&#123;end&#125;&#125;&#123;&#123;end&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://zhongpan.tech/2019/10/30/018-output-change-kubectl-get-cs/">https://zhongpan.tech/2019/10/30/018-output-change-kubectl-get-cs/</a></p>
<p>Github Issue：<a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://github.com/kubernetes/kubernetes/issues/83024">https://github.com/kubernetes/kubernetes/issues/83024</a></p>
<p><strong>检查 kube-apiserver 监听的端口</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netstat -lnpt|grep kube</span><br></pre></td></tr></table></figure>
<ul>
<li>6443: 接收 https 请求的安全端口，对所有请求做认证和授权；</li>
<li>由于关闭了非安全端口，故没有监听 8080；</li>
</ul>
<h2 id="6-2、Controller-Manager集群"><a href="#6-2、Controller-Manager集群" class="headerlink" title="6.2、Controller-Manager集群"></a>6.2、Controller-Manager集群</h2><p>本小节介绍部署高可用 kube-controller-manager 集群的步骤。该集群包含 3 个节点，启动后将通过竞争选举机制产生一个 leader 节点，其它节点为阻塞状态。当 leader 节点不可用时，阻塞的节点将再次进行选举产生新的 leader 节点，从而保证服务的可用性。</p>
<p>为保证通信安全，本文档先生成 x509 证书和私钥，kube-controller-manager 在如下两种情况下使用该证书：</p>
<ol>
<li>与 kube-apiserver 的安全端口通信;</li>
<li>在<strong>安全端口</strong>(https，10252) 输出 prometheus 格式的 metrics；</li>
</ol>
<p>注：如果没有特殊指明，本小节的所有操作均在 <strong>Kubernetes-01</strong> 节点上执行。</p>
<p><strong>创建 kube-controller-manager 证书和私钥</strong></p>
<p>创建证书签名请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cat &gt; kube-controller-manager-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;172.16.200.11&quot;,</span><br><span class="line">      &quot;172.16.200.12&quot;,</span><br><span class="line">      &quot;172.16.200.13&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">        &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">        &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">        &quot;O&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">        &quot;OU&quot;: &quot;z0ukun&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>hosts 列表包含<strong>所有</strong> kube-controller-manager 节点 IP；</li>
<li>CN 和 O 均为 system:kube-controller-manager，kubernetes 内置的 ClusterRoleBindings system:kube-controller-manager 赋予 kube-controller-manager 工作所需的权限。</li>
</ul>
<p><strong>生成证书和私钥：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cfssl gencert -ca&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca.pem \</span><br><span class="line">  -ca-key&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca-key.pem \</span><br><span class="line">  -config&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca-config.json \</span><br><span class="line">  -profile&#x3D;kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br><span class="line">ls kube-controller-manager*pem</span><br></pre></td></tr></table></figure>


<p><strong>将生成的证书和私钥分发到所有 master 节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp kube-controller-manager*.pem root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>创建和分发 kubeconfig 文件</strong></p>
<p>kube-controller-manager 使用 kubeconfig 文件访问 apiserver，该文件提供了 apiserver 地址、嵌入的 CA 证书和 kube-controller-manager 证书等信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --server&#x3D;&quot;https:&#x2F;&#x2F;##NODE_IP##:6443&quot; \</span><br><span class="line">  --kubeconfig&#x3D;kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials system:kube-controller-manager \</span><br><span class="line">  --client-certificate&#x3D;kube-controller-manager.pem \</span><br><span class="line">  --client-key&#x3D;kube-controller-manager-key.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --kubeconfig&#x3D;kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context system:kube-controller-manager \</span><br><span class="line">  --cluster&#x3D;kubernetes \</span><br><span class="line">  --user&#x3D;system:kube-controller-manager \</span><br><span class="line">  --kubeconfig&#x3D;kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context system:kube-controller-manager --kubeconfig&#x3D;kube-controller-manager.kubeconfig</span><br></pre></td></tr></table></figure>
<ul>
<li>kube-controller-manager 与 kube-apiserver 混布，故直接通过<strong>节点 IP</strong> 访问 kube-apiserver。</li>
</ul>
<p><strong>分发 kubeconfig 到所有 master 节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    sed -e &quot;s&#x2F;##NODE_IP##&#x2F;$&#123;node_ip&#125;&#x2F;&quot; kube-controller-manager.kubeconfig &gt; kube-controller-manager-$&#123;node_ip&#125;.kubeconfig</span><br><span class="line">    scp kube-controller-manager-$&#123;node_ip&#125;.kubeconfig root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;kubernetes&#x2F;kube-controller-manager.kubeconfig</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>创建 kube-controller-manager systemd unit 模板文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s/work</span><br><span class="line">source /opt/k8s/bin/environment.sh</span><br><span class="line">cat &gt; kube-controller-manager.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=$&#123;K8S_DIR&#125;/kube-controller-manager</span><br><span class="line">ExecStart=/opt/k8s/bin/kube-controller-manager \\</span><br><span class="line">  --profiling \\</span><br><span class="line">  --cluster-name=kubernetes \\</span><br><span class="line">  --controllers=*,bootstrapsigner,tokencleaner \\</span><br><span class="line">  --kube-api-qps=1000 \\</span><br><span class="line">  --kube-api-burst=2000 \\</span><br><span class="line">  --leader-elect \\</span><br><span class="line">  --use-service-account-credentials\\</span><br><span class="line">  --concurrent-service-syncs=2 \\</span><br><span class="line">  --bind-address=##NODE_IP## \\</span><br><span class="line">  --secure-port=10252 \\</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/cert/kube-controller-manager.pem \\</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/cert/kube-controller-manager-key.pem \\</span><br><span class="line">  --port=0 \\</span><br><span class="line">  --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">  --client-ca-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --requestheader-allowed-names=&quot;aggregator&quot; \\</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --requestheader-extra-headers-prefix=&quot;X-Remote-Extra-&quot; \\</span><br><span class="line">  --requestheader-group-headers=X-Remote-Group \\</span><br><span class="line">  --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">  --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">  --cluster-signing-cert-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --cluster-signing-key-file=/etc/kubernetes/cert/ca-key.pem \\</span><br><span class="line">  --experimental-cluster-signing-duration=876000h \\</span><br><span class="line">  --horizontal-pod-autoscaler-sync-period=10s \\</span><br><span class="line">  --concurrent-deployment-syncs=10 \\</span><br><span class="line">  --concurrent-gc-syncs=30 \\</span><br><span class="line">  --node-cidr-mask-size=24 \\</span><br><span class="line">  --service-cluster-ip-range=$&#123;SERVICE_CIDR&#125; \\</span><br><span class="line">  --pod-eviction-timeout=6m \\</span><br><span class="line">  --terminated-pod-gc-threshold=10000 \\</span><br><span class="line">  --root-ca-file=/etc/kubernetes/cert/ca.pem \\</span><br><span class="line">  --service-account-private-key-file=/etc/kubernetes/cert/ca-key.pem \\</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">  --logtostderr=true \\</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">--profiling：通过位于 host:port/debug/pprof/ 的 Web 接口启用性能分析</span><br><span class="line"></span><br><span class="line">--cluster-name：默认值：&quot;kubernetes&quot;，集群实例的前缀</span><br><span class="line"></span><br><span class="line">--controllers：要启用的控制器列表。* 表示启用所有默认启用的控制器；foo 启用名为 foo 的控制器；-foo 表示禁用名为 foo 的控制器。</span><br><span class="line"></span><br><span class="line">--kube-api-qps：与 API 服务器通信时每秒请求数（QPS）限制</span><br><span class="line"></span><br><span class="line">--kube-api-burst：与 Kubernetes API 服务器通信时突发峰值请求个数上限</span><br><span class="line"></span><br><span class="line">--leader-elect：在执行主循环之前，启动领导选举（Leader Election）客户端，并尝试获得领导者身份。在运行多副本组件时启用此标志有助于提高可用性。</span><br><span class="line"></span><br><span class="line">--use-service-account-credentials：当此标志为 true 时，为每个控制器单独使用服务账号凭据</span><br><span class="line"></span><br><span class="line">--concurrent-service-syncs：可以并发同步的 Service 对象个数。数值越大，服务管理的响应速度越快，不过对 CPU （和网络）的占用也越高。</span><br><span class="line"> </span><br><span class="line">--bind-address：针对 --secure-port 端口上请求执行监听操作的 IP 地址。所对应的网络接口必须从集群中其它位置可访问（含命令行及 Web 客户端）。如果此值为空或者设定为非特定地址（0.0.0.0 或 ::），意味着所有网络接口都在监听范围。</span><br><span class="line"></span><br><span class="line">--secure-port：在此端口上提供 HTTPS 身份认证和鉴权操作。若此标志值为0，则不提供 HTTPS 服务。</span><br><span class="line"></span><br><span class="line">--tls-*-file：包含 HTTPS 所用的默认 X509 证书的文件</span><br><span class="line"></span><br><span class="line">--port：用于服务不安全，未经身份验证的访问的端口。设置为0禁用。 （默认值为10252）</span><br><span class="line"></span><br><span class="line">--authentication-kubeconfig：kube-controller-manager 使用它连接 apiserver，对 client 的请求进行认证和授权。kube-controller-manager 不再使用 --tls-ca-file 对请求 https metrics 的 Client 证书进行校验。如果没有配置这两个 kubeconfig 参数，则 client 连接 kube-controller-manager https 端口的请求会被拒绝(提示权限不足)</span><br><span class="line"></span><br><span class="line">--cluster-signing-*-file：签名 TLS Bootstrap 创建的证书；</span><br><span class="line"></span><br><span class="line">--experimental-cluster-signing-duration：所签署的证书的有效期时长。</span><br><span class="line"></span><br><span class="line">--horizontal-pod-autoscaler-sync-period：水平 Pod 扩缩器对 Pods 数目执行同步操作的周期</span><br><span class="line"></span><br><span class="line">--concurrent-deployment-syncs：可以并发同步的 Deployment 对象个数。数值越大意味着对 Deployment 的响应越及时，同时也意味着更大的 CPU（和网络带宽）压力。</span><br><span class="line"></span><br><span class="line">--concurrent-gc-syncs：可以并发同步的垃圾收集工作线程个数</span><br><span class="line"></span><br><span class="line">--node-cidr-mask-size：集群中节点 CIDR 的掩码长度。对 IPv4 而言默认为 24；对 IPv6 而言默认为 64</span><br><span class="line"></span><br><span class="line">--service-cluster-ip-range：集群中 Service 对象的 CIDR 范围。要求 --allocate-node-cidrs 标志为 true</span><br><span class="line"></span><br><span class="line">--pod-eviction-timeout：在失效的节点上删除 Pods 时为其预留的宽限期</span><br><span class="line"></span><br><span class="line"> --terminated-pod-gc-threshold：在已终止 Pods 垃圾收集器删除已终止 Pods 之前，可以保留的已删除 Pods 的个数上限。若此值小于等于 0，则相当于禁止垃圾回收已终止的 Pods。</span><br><span class="line"></span><br><span class="line">--root-ca-file：放置到容器 ServiceAccount 中的 CA 证书，用来对 kube-apiserver 的证书进行校验；</span><br><span class="line"></span><br><span class="line">--service-account-private-key-file：签名 ServiceAccount 中 Token 的私钥文件，必须和 kube-apiserver 的 --service-account-key-file 指定的公钥文件配对使用；</span><br></pre></td></tr></table></figure>


<p><strong>为各节点创建和分发 kube-controller-mananger systemd unit 文件</strong></p>
<p>替换模板文件中的变量，为各节点创建 systemd unit 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for (( i&#x3D;0; i &lt; 3; i++ ))</span><br><span class="line">  do</span><br><span class="line">    sed -e &quot;s&#x2F;##NODE_NAME##&#x2F;$&#123;NODE_NAMES[i]&#125;&#x2F;&quot; -e &quot;s&#x2F;##NODE_IP##&#x2F;$&#123;NODE_IPS[i]&#125;&#x2F;&quot; kube-controller-manager.service.template &gt; kube-controller-manager-$&#123;NODE_IPS[i]&#125;.service </span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">ls kube-controller-manager*.service</span><br></pre></td></tr></table></figure>


<p><strong>分发到所有 master 节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp kube-controller-manager-$&#123;node_ip&#125;.service root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;kube-controller-manager.service</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>启动 kube-controller-manager 服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;mkdir -p $&#123;K8S_DIR&#125;&#x2F;kube-controller-manager&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager &amp;&amp; systemctl restart kube-controller-manager&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>检查服务运行状态</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;systemctl status kube-controller-manager|grep Active&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p>kube-controller-manager 监听 10252 端口，接收 https 请求：</p>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223626361.png" alt="image-20210114223626361"></p>
<p><strong>查看输出的 metrics</strong></p>
<p>下面的命令在 kube-controller-manager 节点上执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s --cacert &#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca.pem --cert &#x2F;opt&#x2F;k8s&#x2F;work&#x2F;admin.pem --key &#x2F;opt&#x2F;k8s&#x2F;work&#x2F;admin-key.pem https:&#x2F;&#x2F;$(hostname -I | awk &#39;&#123;print $1&#125;&#39;):10252&#x2F;metrics |head</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223634689.png" alt="image-20210114223634689"></p>
<p><strong>查看当前的 leader</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get endpoints kube-controller-manager --namespace&#x3D;kube-system  -o yaml</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223640108.png" alt="image-20210114223640108">可见，当前的 leader 为 Kubernetes-01 节点。</p>
<p><strong>测试 kube-controller-manager 集群的高可用</strong></p>
<p>停掉一个或两个节点的 kube-controller-manager 服务，观察其它节点的日志，看是否获取了 leader 权限。</p>
<ul>
<li>关于 controller 权限和 use-service-account-credentials 参数：<a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://github.com/kubernetes/kubernetes/issues/48208">https://github.com/kubernetes/kubernetes/issues/48208</a></li>
<li>kubelet 认证和授权：<a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://kubernetes.io/docs/admin/kubelet-authentication-authorization/#kubelet-authorization">https://kubernetes.io/docs/admin/kubelet-authentication-authorization/#kubelet-authorization</a></li>
</ul>
<h2 id="6-3、Scheduler集群"><a href="#6-3、Scheduler集群" class="headerlink" title="6.3、Scheduler集群"></a>6.3、Scheduler集群</h2><p>本小节介绍部署高可用 kube-scheduler 集群的步骤。该集群包含 3 个节点，启动后将通过竞争选举机制产生一个 leader 节点，其它节点为阻塞状态。当 leader 节点不可用后，剩余节点将再次进行选举产生新的 leader 节点，从而保证服务的可用性。为保证通信安全，本文档先生成 x509 证书和私钥，kube-scheduler 在如下两种情况下使用该证书：</p>
<ul>
<li>与 kube-apiserver 的安全端口通信;</li>
<li>在<strong>安全端口</strong>(https，10251) 输出 prometheus 格式的 metrics；</li>
</ul>
<p>注：如果没有特殊指明，本小节的所有操作<strong>均在 Kubernetes-01 节点上执行</strong>。</p>
<p><strong>创建 kube-scheduler 证书和私钥</strong></p>
<p>创建证书签名请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cat &gt; kube-scheduler-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;172.16.200.11&quot;,</span><br><span class="line">      &quot;172.16.200.12&quot;,</span><br><span class="line">      &quot;172.16.200.13&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">        &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">        &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">        &quot;O&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">        &quot;OU&quot;: &quot;z0ukun&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>hosts 列表包含<strong>所有</strong> kube-scheduler 节点 IP；</li>
<li>CN 和 O 均为 system:kube-scheduler，kubernetes 内置的 ClusterRoleBindings system:kube-scheduler 将赋予 kube-scheduler 工作所需的权限；</li>
</ul>
<p><strong>生成证书和私钥：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cfssl gencert -ca&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca.pem \</span><br><span class="line">  -ca-key&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca-key.pem \</span><br><span class="line">  -config&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca-config.json \</span><br><span class="line">  -profile&#x3D;kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br><span class="line"></span><br><span class="line">ls kube-scheduler*pem</span><br></pre></td></tr></table></figure>


<p><strong>将生成的证书和私钥分发到所有 master 节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp kube-scheduler*.pem root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>创建和分发 kubeconfig 文件</strong></p>
<p>kube-scheduler 使用 kubeconfig 文件访问 apiserver，该文件提供了 apiserver 地址、嵌入的 CA 证书和 kube-scheduler 证书：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --server&#x3D;&quot;https:&#x2F;&#x2F;##NODE_IP##:6443&quot; \</span><br><span class="line">  --kubeconfig&#x3D;kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials system:kube-scheduler \</span><br><span class="line">  --client-certificate&#x3D;kube-scheduler.pem \</span><br><span class="line">  --client-key&#x3D;kube-scheduler-key.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --kubeconfig&#x3D;kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context system:kube-scheduler \</span><br><span class="line">  --cluster&#x3D;kubernetes \</span><br><span class="line">  --user&#x3D;system:kube-scheduler \</span><br><span class="line">  --kubeconfig&#x3D;kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context system:kube-scheduler --kubeconfig&#x3D;kube-scheduler.kubeconfig</span><br></pre></td></tr></table></figure>


<p><strong>分发 kubeconfig 到所有 master 节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    sed -e &quot;s&#x2F;##NODE_IP##&#x2F;$&#123;node_ip&#125;&#x2F;&quot; kube-scheduler.kubeconfig &gt; kube-scheduler-$&#123;node_ip&#125;.kubeconfig</span><br><span class="line">    scp kube-scheduler-$&#123;node_ip&#125;.kubeconfig root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;kubernetes&#x2F;kube-scheduler.kubeconfig</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>创建 kube-scheduler 配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cat &gt;kube-scheduler.yaml.template &lt;&lt;EOF</span><br><span class="line">apiVersion: kubescheduler.config.k8s.io&#x2F;v1alpha1</span><br><span class="line">kind: KubeSchedulerConfiguration</span><br><span class="line">bindTimeoutSeconds: 600</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: 200</span><br><span class="line">  kubeconfig: &quot;&#x2F;etc&#x2F;kubernetes&#x2F;kube-scheduler.kubeconfig&quot;</span><br><span class="line">  qps: 100</span><br><span class="line">enableContentionProfiling: false</span><br><span class="line">enableProfiling: true</span><br><span class="line">hardPodAffinitySymmetricWeight: 1</span><br><span class="line">healthzBindAddress: ##NODE_IP##:10251</span><br><span class="line">leaderElection:</span><br><span class="line">  leaderElect: true</span><br><span class="line">metricsBindAddress: ##NODE_IP##:10251</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>–kubeconfig：指定 kubeconfig 文件路径，kube-scheduler 使用它连接和验证 kube-apiserver；</li>
<li>–leader-elect=true：集群运行模式，启用选举功能；被选为 leader 的节点负责处理工作，其它节点为阻塞状态；</li>
</ul>
<p><strong>替换模板文件中的变量：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for (( i&#x3D;0; i &lt; 3; i++ ))</span><br><span class="line">  do</span><br><span class="line">    sed -e &quot;s&#x2F;##NODE_NAME##&#x2F;$&#123;NODE_NAMES[i]&#125;&#x2F;&quot; -e &quot;s&#x2F;##NODE_IP##&#x2F;$&#123;NODE_IPS[i]&#125;&#x2F;&quot; kube-scheduler.yaml.template &gt; kube-scheduler-$&#123;NODE_IPS[i]&#125;.yaml</span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">ls kube-scheduler*.yaml</span><br></pre></td></tr></table></figure>
<ul>
<li>NODE_NAMES 和 NODE_IPS 为相同长度的 bash 数组，分别为节点名称和对应的 IP；</li>
</ul>
<p><strong>分发 kube-scheduler 配置文件到所有 master 节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp kube-scheduler-$&#123;node_ip&#125;.yaml root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;kubernetes&#x2F;kube-scheduler.yaml</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<ul>
<li>重命名为 kube-scheduler.yaml;</li>
</ul>
<p><strong>创建 kube-scheduler systemd unit 模板文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">cat &gt; kube-scheduler.service.template &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Kubernetes Scheduler</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;github.com&#x2F;GoogleCloudPlatform&#x2F;kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory&#x3D;$&#123;K8S_DIR&#125;&#x2F;kube-scheduler</span><br><span class="line">ExecStart&#x3D;&#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;kube-scheduler \\</span><br><span class="line">  --config&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;kube-scheduler.yaml \\</span><br><span class="line">  --bind-address&#x3D;##NODE_IP## \\</span><br><span class="line">  --secure-port&#x3D;10259 \\</span><br><span class="line">  --port&#x3D;0 \\</span><br><span class="line">  --tls-cert-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;kube-scheduler.pem \\</span><br><span class="line">  --tls-private-key-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;kube-scheduler-key.pem \\</span><br><span class="line">  --authentication-kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;kube-scheduler.kubeconfig \\</span><br><span class="line">  --client-ca-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;ca.pem \\</span><br><span class="line">  --requestheader-allowed-names&#x3D;&quot;&quot; \\</span><br><span class="line">  --requestheader-client-ca-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;ca.pem \\</span><br><span class="line">  --requestheader-extra-headers-prefix&#x3D;&quot;X-Remote-Extra-&quot; \\</span><br><span class="line">  --requestheader-group-headers&#x3D;X-Remote-Group \\</span><br><span class="line">  --requestheader-username-headers&#x3D;X-Remote-User \\</span><br><span class="line">  --authorization-kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;kube-scheduler.kubeconfig \\</span><br><span class="line">  --logtostderr&#x3D;true \\</span><br><span class="line">  --v&#x3D;2</span><br><span class="line">Restart&#x3D;always</span><br><span class="line">RestartSec&#x3D;5</span><br><span class="line">StartLimitInterval&#x3D;0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>


<p><strong>为各节点创建和分发 kube-scheduler systemd unit 文件</strong></p>
<p>替换模板文件中的变量，为各节点创建 systemd unit 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for (( i&#x3D;0; i &lt; 3; i++ ))</span><br><span class="line">  do</span><br><span class="line">    sed -e &quot;s&#x2F;##NODE_NAME##&#x2F;$&#123;NODE_NAMES[i]&#125;&#x2F;&quot; -e &quot;s&#x2F;##NODE_IP##&#x2F;$&#123;NODE_IPS[i]&#125;&#x2F;&quot; kube-scheduler.service.template &gt; kube-scheduler-$&#123;NODE_IPS[i]&#125;.service </span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">ls kube-scheduler*.service</span><br></pre></td></tr></table></figure>


<p><strong>分发 systemd unit 文件到所有 master 节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp kube-scheduler-$&#123;node_ip&#125;.service root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;kube-scheduler.service</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>启动 kube-scheduler 服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;mkdir -p $&#123;K8S_DIR&#125;&#x2F;kube-scheduler&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler &amp;&amp; systemctl restart kube-scheduler&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>检查服务运行状态</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;systemctl status kube-scheduler|grep Active&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>查看输出的 metrics</strong></p>
<p>注：以下命令在 kube-scheduler 节点上执行。</p>
<p>kube-scheduler 监听 10251 和 10259 端口：</p>
<ul>
<li>10251：接收 http 请求，非安全端口，不需要认证授权；</li>
<li>10259：接收 https 请求，安全端口，需要认证授权；</li>
</ul>
<p>两个接口都对外提供 /metrics 和 /healthz 的访问。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s http:&#x2F;&#x2F;192.168.10.20:10251&#x2F;metrics |head</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223651605.png" alt="image-20210114223651605"> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s --cacert /opt/k8s/work/ca.pem --cert /opt/k8s/work/admin.pem --key /opt/k8s/work/admin-key.pem https://192.168.10.20:10259/metrics |head</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223656926.png" alt="image-20210114223656926"></p>
<p><strong>查看当前的 leader</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get endpoints kube-scheduler --namespace&#x3D;kube-system  -o yaml</span><br></pre></td></tr></table></figure>


<p><strong>测试 kube-scheduler 集群的高可用</strong></p>
<p>随便找一个或两个 master 节点，停掉 kube-scheduler 服务，看其它节点是否获取了 leader 权限。</p>
<h1 id="7、部署Flannel网络"><a href="#7、部署Flannel网络" class="headerlink" title="7、部署Flannel网络"></a>7、部署Flannel网络</h1><p>注：切记在开始部署Worker集群之前、我们需要先去部署Flannel网络和Docker。</p>
<p>kubernetes 要求集群内各节点(包括 master 节点)能通过 Pod 网段互联互通。flannel 使用 vxlan 技术为各节点创建一个可以互通的 Pod 网络，使用的端口为 UDP 8472（需要开放该端口，如公有云 AWS 等）。</p>
<p>flanneld 第一次启动时，从 etcd 获取配置的 Pod 网段信息，为本节点分配一个未使用的地址段，然后创建 flannedl.1 网络接口（也可能是其它名称，如 flannel1 等）。 flannel 将分配给自己的 Pod 网段信息写入 /run/flannel/docker 文件，docker 后续使用这个文件中的环境变量设置 docker0 网桥，从而从这个地址段为本节点的所有 Pod 容器分配 IP。</p>
<ul>
<li>flanneld 与本文档部署的 etcd v3.4.x 不兼容，需要将 etcd 降级到 v3.3.x；</li>
<li>flanneld 与 docker 结合使用；</li>
</ul>
<p><strong>注：</strong> 如果没有特殊指明，本小节的所有操作均在 Kubernetes-01 节点上执行，然后远程分发文件和执行命令；</p>
<p><strong>下载Flanneld二进制文件</strong></p>
<p>Flanneld下载地址：<a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://github.com/coreos/flannel/releases">https://github.com/coreos/flannel/releases</a></p>
<p>我们从上面的 Flanneld下载地址 下载安装包（这里我们安装flannel-v0.11.0）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">mkdir flannel</span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;coreos&#x2F;flannel&#x2F;releases&#x2F;download&#x2F;v0.11.0&#x2F;flannel-v0.11.0-linux-amd64.tar.gz</span><br><span class="line">tar -xzvf flannel-v0.11.0-linux-amd64.tar.gz -C flannel</span><br></pre></td></tr></table></figure>


<p><strong>分发二进制文件到集群所有节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp flannel&#x2F;&#123;flanneld,mk-docker-opts.sh&#125; root@$&#123;node_ip&#125;:&#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;chmod +x &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;*&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223704848.png" alt="image-20210114223704848"></p>
<p><strong>创建Flannel证书和私钥</strong></p>
<p>flanneld 从 etcd 集群存取网段分配信息，而 etcd 集群启用了双向 x509 证书认证，所以需要为 flanneld 生成证书和私钥。创建证书签名请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cat &gt; flanneld-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;flanneld&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;4Paradigm&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>该证书只会被 kubectl 当做 client 证书使用，所以 hosts 字段为空。</li>
</ul>
<p><strong>生成证书和私钥：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca.pem \</span><br><span class="line">  -ca-key&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca-key.pem \</span><br><span class="line">  -config&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca-config.json \</span><br><span class="line">  -profile&#x3D;kubernetes flanneld-csr.json | cfssljson -bare flanneld</span><br><span class="line"></span><br><span class="line">ls flanneld*pem</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223710782.png" alt="image-20210114223710782"></p>
<p>将生成的证书和私钥分发到<strong>所有节点</strong>（master 和 worker）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;mkdir -p &#x2F;etc&#x2F;flanneld&#x2F;cert&quot;</span><br><span class="line">    scp flanneld*.pem root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;flanneld&#x2F;cert</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223718385.png" alt="image-20210114223718385"></p>
<p><strong>向etcd写入集群Pod网段信息（本步骤只需执行一次）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">ETCDCTL_API&#x3D;2 etcdctl \</span><br><span class="line">  --endpoints&#x3D;$&#123;ETCD_ENDPOINTS&#125; \</span><br><span class="line">  --ca-file&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;ca.pem \</span><br><span class="line">  --cert-file&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;flanneld.pem \</span><br><span class="line">  --key-file&#x3D;&#x2F;opt&#x2F;k8s&#x2F;work&#x2F;flanneld-key.pem \</span><br><span class="line">  mk $&#123;FLANNEL_ETCD_PREFIX&#125;&#x2F;config &#39;&#123;&quot;Network&quot;:&quot;&#39;$&#123;CLUSTER_CIDR&#125;&#39;&quot;, &quot;SubnetLen&quot;: 24, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>
<ul>
<li>flanneld 当前版本 (v0.11.0) 不支持 etcd v3，故使用 etcd v2 API 写入配置 key 和网段数据；</li>
<li>写入的 Pod 网段 ${CLUSTER_CIDR} 地址段（如 /16）必须小于 SubnetLen，必须与 kube-controller-manager 的 –cluster-cidr 参数值一致；</li>
</ul>
<p>注：这里是Flannel网络部署的最大坑点、如果是v0.11.0版本在执行此命令之前一定要在前面加上 ETCDCTL_API=2 强制使用ETCD V2版本。</p>
<p><strong>创建 flanneld 的 systemd unit 文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">cat &gt; flanneld.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Flanneld overlay address etcd agent</span><br><span class="line">After&#x3D;network.target</span><br><span class="line">After&#x3D;network-online.target</span><br><span class="line">Wants&#x3D;network-online.target</span><br><span class="line">After&#x3D;etcd.service</span><br><span class="line">Before&#x3D;docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;notify</span><br><span class="line">ExecStart&#x3D;&#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;flanneld \\</span><br><span class="line">  -etcd-cafile&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;cert&#x2F;ca.pem \\</span><br><span class="line">  -etcd-certfile&#x3D;&#x2F;etc&#x2F;flanneld&#x2F;cert&#x2F;flanneld.pem \\</span><br><span class="line">  -etcd-keyfile&#x3D;&#x2F;etc&#x2F;flanneld&#x2F;cert&#x2F;flanneld-key.pem \\</span><br><span class="line">  -etcd-endpoints&#x3D;$&#123;ETCD_ENDPOINTS&#125; \\</span><br><span class="line">  -etcd-prefix&#x3D;$&#123;FLANNEL_ETCD_PREFIX&#125; \\</span><br><span class="line">  -iface&#x3D;$&#123;IFACE&#125; \\</span><br><span class="line">  -ip-masq</span><br><span class="line">ExecStartPost&#x3D;&#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d &#x2F;run&#x2F;flannel&#x2F;docker</span><br><span class="line">Restart&#x3D;always</span><br><span class="line">RestartSec&#x3D;5</span><br><span class="line">StartLimitInterval&#x3D;0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">RequiredBy&#x3D;docker.service</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>mk-docker-opts.sh 脚本将分配给 flanneld 的 Pod 子网段信息写入 /run/flannel/docker 文件，后续 docker 启动时使用这个文件中的环境变量配置 docker0 网桥；</li>
<li>flanneld 使用系统缺省路由所在的接口与其它节点通信，对于有多个网络接口（如内网和公网）的节点，可以用 -iface 参数指定通信接口;</li>
<li>flanneld 运行时需要 root 权限；</li>
<li>-ip-masq: flanneld 为访问 Pod 网络外的流量设置 SNAT 规则，同时将传递给 Docker 的变量 –ip-masq（/run/flannel/docker 文件中）设置为 false，这样 Docker 将不再创建 SNAT 规则； Docker 的 –ip-masq 为 true 时，创建的 SNAT 规则比较“暴力”：将所有本节点 Pod 发起的、访问非 docker0 接口的请求做 SNAT，这样访问其他节点 Pod 的请求来源 IP 会被设置为 flannel.1 接口的 IP，导致目的 Pod 看不到真实的来源 Pod IP。 flanneld 创建的 SNAT 规则比较温和，只对访问非 Pod 网段的请求做 SNAT。</li>
</ul>
<p><strong>分发 flanneld systemd unit 文件到所有节点</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp flanneld.service root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>启动 flanneld 服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;systemctl daemon-reload &amp;&amp; systemctl enable flanneld &amp;&amp; systemctl restart flanneld&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>检查启动结果</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;systemctl status flanneld|grep Active&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<p>确保状态为 active (running)，否则可以通过 journalctl -u flanneld 命令查看日志，确认原因。</p>
<p><strong>检查分配给各 flanneld 的 Pod 网段信息</strong></p>
<p>查看集群 Pod 网段(/16)：</p>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223725868.png" alt="image-20210114223725868"></p>
<p>查看已分配的 Pod 子网段列表(/24):</p>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223730344.png" alt="image-20210114223730344"></p>
<p>查看某一 Pod 网段对应的节点 IP 和 flannel 接口地址:</p>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223735935.png" alt="image-20210114223735935"></p>
<ul>
<li>172.30.41.0/24 被分配给节点 Kubernetes-03（172.16.200.13）；</li>
<li>VtepMAC 为 Kubernetes-03 节点的 flannel.1 网卡 MAC 地址；</li>
</ul>
<p><strong>检查节点 flannel 网络信息</strong></p>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223741291.png" alt="image-20210114223741291"></p>
<p>flannel.1 网卡的地址为分配的 Pod 子网段的第一个 IP（.0），且是 /32 的地址；</p>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223746506.png" alt="image-20210114223746506"></p>
<ul>
<li>到其它节点 Pod 网段请求都被转发到 flannel.1 网卡；</li>
<li>flanneld 根据 etcd 中子网段的信息，如 ${FLANNEL_ETCD_PREFIX}/subnets/172.30.42.0-24 ，来决定进请求发送给哪个节点的互联 IP；</li>
</ul>
<p><strong>验证各节点能否通过Pod网络互通</strong></p>
<p>在<strong>各节点上部署</strong> flannel 后，检查是否创建了 flannel 接口(名称可能为 flannel0、flannel.0、flannel.1 等)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh $&#123;node_ip&#125; &quot;&#x2F;usr&#x2F;sbin&#x2F;ip addr show flannel.1|grep -w inet&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223752844.png" alt="image-20210114223752844"></p>
<p><strong>在各节点上 ping 所有 flannel 接口 IP，确保能通：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh $&#123;node_ip&#125; &quot;ping -c 1 172.30.41.0&quot;</span><br><span class="line">    ssh $&#123;node_ip&#125; &quot;ping -c 1 172.30.42.0&quot;</span><br><span class="line">    ssh $&#123;node_ip&#125; &quot;ping -c 1 172.30.62.0&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223758350.png" alt="image-20210114223758350"></p>
<h1 id="8、部署Docker"><a href="#8、部署Docker" class="headerlink" title="8、部署Docker"></a>8、部署Docker</h1><p>docker 运行和管理容器，kubelet 通过 Container Runtime Interface (CRI) 与它进行交互。</p>
<p>注：在开始部署Docker之前一定要记得提前部署Flannel网络；如果没有特殊指明，本小节的所有操作<strong>均在 Kubernetes-01 节点上执行</strong>，然后远程分发文件和执行命令；如果之前安装过Docker的相关版本、记得一定要把Docker提前卸载干净。</p>
<p>Docker卸载命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 查询已安装的Docker版本</span><br><span class="line">rpm -qa | grep docker</span><br><span class="line"></span><br><span class="line"># 卸载已安装的Docker版本</span><br><span class="line">yum remove -y *** </span><br><span class="line"></span><br><span class="line"># 重启主机</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>


<p><strong>安装依赖包</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;yum install -y epel-release&quot; &amp;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;yum install -y chrony conntrack ipvsadm ipset jq iptables curl sysstat libseccomp wget socat git&quot; &amp;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>下载Docker二进制文件：</strong></p>
<p>Docker下载地址：<a target="_blank" rel="noopener" href="https://blog.z0ukun.com/wp-content/themes/begin4.6/inc/go.php?url=https://download.docker.com/linux/static/stable/x86_64/">https://download.docker.com/linux/static/stable/x86_64/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">wget https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;static&#x2F;stable&#x2F;x86_64&#x2F;docker-18.09.6.tgz</span><br><span class="line">tar -xvf docker-18.09.6.tgz</span><br></pre></td></tr></table></figure>


<p><strong>分发Docker二进制文件到所有的Worker节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp docker&#x2F;*  root@$&#123;node_ip&#125;:&#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;chmod +x &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;*&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>创建和分发 systemd unit 文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">cat &gt; docker.service &lt;&lt;&quot;EOF&quot;</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Docker Application Container Engine</span><br><span class="line">Documentation&#x3D;http:&#x2F;&#x2F;docs.docker.io</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory&#x3D;##DOCKER_DIR##</span><br><span class="line">Environment&#x3D;&quot;PATH&#x3D;&#x2F;opt&#x2F;k8s&#x2F;bin:&#x2F;bin:&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;usr&#x2F;sbin&quot;</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;run&#x2F;flannel&#x2F;docker</span><br><span class="line">ExecStart&#x3D;&#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;dockerd $DOCKER_NETWORK_OPTIONS</span><br><span class="line">ExecReload&#x3D;&#x2F;bin&#x2F;kill -s HUP $MAINPID</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">RestartSec&#x3D;5</span><br><span class="line">LimitNOFILE&#x3D;infinity</span><br><span class="line">LimitNPROC&#x3D;infinity</span><br><span class="line">LimitCORE&#x3D;infinity</span><br><span class="line">Delegate&#x3D;yes</span><br><span class="line">KillMode&#x3D;process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>EOF 前后有双引号，这样 bash 不会替换文档中的变量，如 $DOCKER_NETWORK_OPTIONS (这些环境变量是 systemd 负责替换的。)；</li>
<li>dockerd 运行时会调用其它 docker 命令，如 docker-proxy，所以需要将 docker 命令所在的目录加到 PATH 环境变量中；</li>
<li>flanneld 启动时将网络配置写入 /run/flannel/docker 文件中，dockerd 启动前读取该文件中的环境变量 DOCKER_NETWORK_OPTIONS ，然后设置 docker0 网桥网段； 如果指定了多个 EnvironmentFile 选项，则必须将 /run/flannel/docker 放在最后(确保 docker0 使用 flanneld 生成的 bip 参数)；</li>
<li>docker 需要以 root 用于运行；</li>
<li>docker 从 1.13 版本开始，可能将 iptables FORWARD chain的默认策略设置为DROP，从而导致 ping 其它 Node 上的 Pod IP 失败，遇到这种情况时，需要手动设置策略为 ACCEPT：sudo iptables -P FORWARD ACCEPT；并且把以下命令写入 /etc/rc.local 文件中，防止节点重启iptables FORWARD chain的默认策略又还原为DROP：/sbin/iptables -P FORWARD ACCEPT</li>
</ul>
<p><strong>分发 systemd unit 文件到所有 worker 机器:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">sed -i -e &quot;s|##DOCKER_DIR##|$&#123;DOCKER_DIR&#125;|&quot; docker.service</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    scp docker.service root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>配置和分发 docker 配置文件</strong></p>
<p>使用国内的仓库镜像服务器以加快 pull image 的速度，同时增加下载的并发数 (需要重启 dockerd 生效)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">cat &gt; docker-daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;: [&quot;https:&#x2F;&#x2F;docker.mirrors.ustc.edu.cn&quot;,&quot;https:&#x2F;&#x2F;hub-mirror.c.163.com&quot;],</span><br><span class="line">    &quot;insecure-registries&quot;: [&quot;docker02:35000&quot;],</span><br><span class="line">    &quot;max-concurrent-downloads&quot;: 20,</span><br><span class="line">    &quot;live-restore&quot;: true,</span><br><span class="line">    &quot;max-concurrent-uploads&quot;: 10,</span><br><span class="line">    &quot;debug&quot;: true,</span><br><span class="line">    &quot;data-root&quot;: &quot;$&#123;DOCKER_DIR&#125;&#x2F;data&quot;,</span><br><span class="line">    &quot;exec-root&quot;: &quot;$&#123;DOCKER_DIR&#125;&#x2F;exec&quot;,</span><br><span class="line">    &quot;log-opts&quot;: &#123;</span><br><span class="line">      &quot;max-size&quot;: &quot;100m&quot;,</span><br><span class="line">      &quot;max-file&quot;: &quot;5&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>


<p><strong>分发 docker 配置文件到所有 worker 节点：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;k8s&#x2F;work</span><br><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;mkdir -p  &#x2F;etc&#x2F;docker&#x2F; $&#123;DOCKER_DIR&#125;&#x2F;&#123;data,exec&#125;&quot;</span><br><span class="line">    scp docker-daemon.json root@$&#123;node_ip&#125;:&#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>启动 docker 服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;systemctl daemon-reload &amp;&amp; systemctl enable docker &amp;&amp; systemctl restart docker&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>


<p><strong>检查服务运行状态</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;systemctl status docker|grep Active&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223807089.png" alt="image-20210114223807089"></p>
<p>确保状态为 active (running)，否则可以通过 journalctl -u docker 查看日志，确认原因。</p>
<p><strong>检查 docker0 网桥</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;opt&#x2F;k8s&#x2F;bin&#x2F;environment.sh</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">  do</span><br><span class="line">    echo &quot;&gt;&gt;&gt; $&#123;node_ip&#125;&quot;</span><br><span class="line">    ssh root@$&#123;node_ip&#125; &quot;&#x2F;usr&#x2F;sbin&#x2F;ip addr show flannel.1 &amp;&amp; &#x2F;usr&#x2F;sbin&#x2F;ip addr show docker0&quot;</span><br><span class="line">  done</span><br></pre></td></tr></table></figure>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223813082.png" alt="image-20210114223813082"></p>
<p>确认各 worker 节点的 docker0 网桥和 flannel.1 接口的 IP 处于同一个网段中(如下 172.30.42.0/32 位于 172.30.42.1/24 中)：</p>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223818702.png" alt="image-20210114223818702"></p>
<p>注: 如果你的服务安装顺序不对或者机器环境比较复杂, docker服务早于flanneld服务安装，此时 worker 节点的 docker0 网桥和 flannel.1 接口的 IP可能不会同处同一个网段下，这个时候请先停止docker服务, 手工删除docker0网卡，重新启动docker服务后即可修复:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker</span><br><span class="line">ip link delete docker0</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure>


<p><strong>查看 docker 的状态信息</strong></p>
<p><img src="https://image-1303893285.cos.ap-shanghai.myqcloud.com/image/image-20210114223823825.png" alt="image-20210114223823825"></p>
<p><strong>更新 kubelet 配置并重启服务（每个节点上都操作）</strong></p>
<p>需要删除 kubelet 的 systemd unit 文件(/etc/systemd/system/kubelet.service)，删除下面 4 行（若有）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--network-plugin&#x3D;cni \\</span><br><span class="line">--cni-conf-dir&#x3D;&#x2F;etc&#x2F;cni&#x2F;net.d \\</span><br><span class="line">--container-runtime&#x3D;remote \\</span><br><span class="line">--container-runtime-endpoint&#x3D;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;containerd&#x2F;containerd.sock \\</span><br></pre></td></tr></table></figure>


<p><strong>然后重启 kubelet 服务：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>


<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><h2 id="1、kubeconfig是什么"><a href="#1、kubeconfig是什么" class="headerlink" title="1、kubeconfig是什么"></a>1、kubeconfig是什么</h2><p>上述配置过程中，kubectl，controller-manager都配置了kubeconfig。</p>
<p>kubeconfig文件是一个文件，用于配置与kubectl命令行工具（或其他客户端）一起使用时对Kubernetes的访问。</p>
<h2 id="2、调度器扩展程序"><a href="#2、调度器扩展程序" class="headerlink" title="2、调度器扩展程序"></a>2、调度器扩展程序</h2><p>上述，scheduler集群配置过程中，出现了 创建scheduler配置文件这步。这实际上是配置了调度器扩展程序。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;kube-scheduler.yaml.template &lt;&lt;EOF</span><br><span class="line">apiVersion: kubescheduler.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeSchedulerConfiguration</span><br><span class="line">bindTimeoutSeconds: 600</span><br><span class="line">clientConnection:</span><br><span class="line">  burst: 200</span><br><span class="line">  kubeconfig: &quot;/etc/kubernetes/kube-scheduler.kubeconfig&quot;</span><br><span class="line">  qps: 100</span><br><span class="line">enableContentionProfiling: false</span><br><span class="line">enableProfiling: true</span><br><span class="line">hardPodAffinitySymmetricWeight: 1</span><br><span class="line">healthzBindAddress: ##NODE_IP##:10251</span><br><span class="line">leaderElection:</span><br><span class="line">  leaderElect: true</span><br><span class="line">metricsBindAddress: ##NODE_IP##:10251</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/custom-kube-scheduler/">自定义 Kubernetes 调度器</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/heavyfish.github.io/2020/11/03/k8s/Kubernetes%20in%20Action%20%E7%AC%94%E8%AE%B0%2012~13/" rel="prev" title="Kubernetes in Action 12～13">
      <i class="fa fa-chevron-left"></i> Kubernetes in Action 12～13
    </a></div>
      <div class="post-nav-item">
    <a href="/heavyfish.github.io/2020/11/15/Go/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="next" title="Go语言学习笔记">
      Go语言学习笔记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E4%BB%B6"><span class="nav-text">参考文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1%E3%80%81%E7%BB%84%E4%BB%B6%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E%EF%BC%88%E5%8F%82%E8%80%83%EF%BC%89"><span class="nav-text">1、组件版本说明（参考）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2%E3%80%81%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">2、系统初始化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3%E3%80%81%E5%88%9B%E5%BB%BACA%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%98%E9%92%A5"><span class="nav-text">3、创建CA证书和秘钥</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4%E3%80%81%E9%83%A8%E7%BD%B2Kubectl%E5%B7%A5%E5%85%B7"><span class="nav-text">4、部署Kubectl工具</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5%E3%80%81%E9%83%A8%E7%BD%B2Etcd%E9%9B%86%E7%BE%A4"><span class="nav-text">5、部署Etcd集群</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6%E3%80%81%E9%83%A8%E7%BD%B2Master%E9%9B%86%E7%BE%A4"><span class="nav-text">6、部署Master集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1%E3%80%81APIServer%E9%9B%86%E7%BE%A4"><span class="nav-text">6.1、APIServer集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2%E3%80%81Controller-Manager%E9%9B%86%E7%BE%A4"><span class="nav-text">6.2、Controller-Manager集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3%E3%80%81Scheduler%E9%9B%86%E7%BE%A4"><span class="nav-text">6.3、Scheduler集群</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7%E3%80%81%E9%83%A8%E7%BD%B2Flannel%E7%BD%91%E7%BB%9C"><span class="nav-text">7、部署Flannel网络</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8%E3%80%81%E9%83%A8%E7%BD%B2Docker"><span class="nav-text">8、部署Docker</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FAQ"><span class="nav-text">FAQ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81kubeconfig%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-text">1、kubeconfig是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E8%B0%83%E5%BA%A6%E5%99%A8%E6%89%A9%E5%B1%95%E7%A8%8B%E5%BA%8F"><span class="nav-text">2、调度器扩展程序</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Shenxr"
      src="/heavyfish.github.io/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Shenxr</p>
  <div class="site-description" itemprop="description">在被人包养前，记录学习笔记的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/heavyfish.github.io/archives">
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/heavyfish.github.io/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shenxr</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">212k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">3:12</span>
</div>
<!--  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>
-->

        








      </div>
    </footer>
  </div>

  
  <script src="/heavyfish.github.io/lib/anime.min.js"></script>
  <script src="/heavyfish.github.io/lib/velocity/velocity.min.js"></script>
  <script src="/heavyfish.github.io/lib/velocity/velocity.ui.min.js"></script>

<script src="/heavyfish.github.io/js/utils.js"></script>

<script src="/heavyfish.github.io/js/motion.js"></script>


<script src="/heavyfish.github.io/js/schemes/pisces.js"></script>


<script src="/heavyfish.github.io/js/next-boot.js"></script>


  <script defer src="/heavyfish.github.io/lib/three/three.min.js"></script>
    <script defer src="/heavyfish.github.io/lib/three/canvas_lines.min.js"></script>
    <script defer src="/heavyfish.github.io/lib/three/canvas_sphere.min.js"></script>


  















  

  

<script src="/heavyfish.github.io/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/heavyfish.github.io/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":100,"height":250,"hOffset":-7,"vOffset":30},"mobile":{"show":false},"log":false,"tagMode":false});</script></body>
</html>
